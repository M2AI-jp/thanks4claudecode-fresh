{
  "format_version": "2.2",
  "meta": {
    "id": "template-strictness-v2",
    "branch": "feat/template-strictness",
    "created": "2026-01-20",
    "status": "completed",
    "review_profile": "standard",
    "reviewed": true,
    "reviewed_by": "reviewer",
    "roles": {
      "orchestrator": "claudecode",
      "worker": "codex",
      "reviewer": "coderabbit",
      "human": "user"
    }
  },
  "goal": {
    "summary": "Verify that _template_rules FORBIDDEN patterns exist and all validation_plan/done_when have command fields",
    "done_when": [
      {
        "criterion": "plan.json の _template_rules.criterion.FORBIDDEN 配列が存在する",
        "command": "jq -e '._template_rules.criterion.FORBIDDEN | length > 0' play/template/plan.json && echo 'exists'",
        "expected": "exists"
      },
      {
        "criterion": "project.json の _template_rules.criterion.FORBIDDEN 配列が存在する",
        "command": "jq -e '._template_rules.criterion.FORBIDDEN | length > 0' play/projects/template/project.json && echo 'exists'",
        "expected": "exists"
      },
      {
        "criterion": "plan.json の全 validation_plan.technical が command フィールドを持つ",
        "command": "jq -e '[.phases[].subtasks[].validation_plan.technical.command] | all' play/template/plan.json && echo 'valid'",
        "expected": "valid"
      },
      {
        "criterion": "project.json の全 done_when が command フィールドを持つ",
        "command": "jq -e '[.goal.done_when[].command] | all' play/projects/template/project.json && echo 'valid'",
        "expected": "valid"
      }
    ],
    "scope": {
      "includes": [
        "play/template/plan.json",
        "play/projects/template/project.json"
      ],
      "excludes": [
        "Existing playbooks",
        "Runtime validation"
      ]
    }
  },
  "context": {
    "analysis_result": {
      "source": "prompt-analyzer",
      "data": {
        "primary_topic_type": "instruction",
        "ready_for_playbook": true,
        "5w1h": {
          "what": "Verify template strictness with FORBIDDEN patterns",
          "where": "play/template/plan.json, play/projects/template/project.json",
          "why": "Prevent reward fraud with strict template rules"
        }
      }
    },
    "user_approved_understanding": {
      "source": "AUTO_APPROVED",
      "approved_at": "2026-01-20",
      "summary": "Template strictness verification with 4 done_when criteria",
      "approved_items": [
        "_template_rules.criterion.FORBIDDEN in plan.json",
        "_template_rules.criterion.FORBIDDEN in project.json",
        "validation_plan.technical.command in plan.json",
        "done_when[].command in project.json"
      ],
      "technical_requirements_confirmed": [
        "jq commands for JSON validation",
        "New template format compliance"
      ]
    }
  },
  "max_iterations": 3,
  "phases": [
    {
      "id": "p1",
      "name": "Verify plan.json template rules",
      "description": "Check _template_rules and validation_plan.technical.command in plan.json",
      "depends_on": [],
      "subtasks": [
        {
          "id": "p1.1",
          "criterion": "_template_rules.criterion.FORBIDDEN 配列が plan.json に存在し、要素数が 1 以上",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "jq -e '._template_rules.criterion.FORBIDDEN | length > 0' play/template/plan.json && echo 'exists'",
              "expected": "exists"
            },
            "consistency": {
              "type": "automated",
              "command": "jq -e '._template_rules.command.FORBIDDEN | length > 0' play/template/plan.json && echo 'exists'",
              "expected": "exists"
            },
            "completeness": {
              "type": "automated",
              "command": "jq -e '._template_rules.expected.FORBIDDEN | length > 0' play/template/plan.json && echo 'exists'",
              "expected": "exists"
            }
          }
        },
        {
          "id": "p1.2",
          "criterion": "plan.json の phases[].subtasks[].validation_plan.technical が command フィールドを持つ",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "jq -e '[.phases[].subtasks[].validation_plan.technical.command] | all' play/template/plan.json && echo 'valid'",
              "expected": "valid"
            },
            "consistency": {
              "type": "automated",
              "command": "jq -e '[.phases[].subtasks[].validation_plan.consistency.command] | all' play/template/plan.json && echo 'valid'",
              "expected": "valid"
            },
            "completeness": {
              "type": "automated",
              "command": "jq -e '[.phases[].subtasks[].validation_plan.completeness.command] | all' play/template/plan.json && echo 'valid'",
              "expected": "valid"
            }
          }
        }
      ]
    },
    {
      "id": "p2",
      "name": "Verify project.json template rules",
      "description": "Check _template_rules and done_when[].command in project.json",
      "depends_on": [],
      "subtasks": [
        {
          "id": "p2.1",
          "criterion": "_template_rules.criterion.FORBIDDEN 配列が project.json に存在し、要素数が 1 以上",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "jq -e '._template_rules.criterion.FORBIDDEN | length > 0' play/projects/template/project.json && echo 'exists'",
              "expected": "exists"
            },
            "consistency": {
              "type": "automated",
              "command": "jq -e '._template_rules.command.FORBIDDEN | length > 0' play/projects/template/project.json && echo 'exists'",
              "expected": "exists"
            },
            "completeness": {
              "type": "automated",
              "command": "jq -e '._template_rules.expected.FORBIDDEN | length > 0' play/projects/template/project.json && echo 'exists'",
              "expected": "exists"
            }
          }
        },
        {
          "id": "p2.2",
          "criterion": "project.json の goal.done_when[] が command フィールドを持つ",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "jq -e '[.goal.done_when[].command] | all' play/projects/template/project.json && echo 'valid'",
              "expected": "valid"
            },
            "consistency": {
              "type": "automated",
              "command": "jq -e '[.goal.done_when[].expected] | all' play/projects/template/project.json && echo 'valid'",
              "expected": "valid"
            },
            "completeness": {
              "type": "automated",
              "command": "jq -e '[.goal.done_when[].criterion] | all' play/projects/template/project.json && echo 'valid'",
              "expected": "valid"
            }
          }
        }
      ]
    },
    {
      "id": "p_final",
      "name": "Final verification",
      "description": "Execute all done_when commands and verify results",
      "depends_on": ["p1", "p2"],
      "subtasks": [
        {
          "id": "p_final.1",
          "criterion": "goal.done_when の全コマンドが expected を返す",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "jq -e '._template_rules.criterion.FORBIDDEN | length > 0' play/template/plan.json && jq -e '._template_rules.criterion.FORBIDDEN | length > 0' play/projects/template/project.json && echo 'pass'",
              "expected": "pass"
            },
            "consistency": {
              "type": "automated",
              "command": "jq -e '[.phases[].subtasks[].validation_plan.technical.command] | all' play/template/plan.json && jq -e '[.goal.done_when[].command] | all' play/projects/template/project.json && echo 'pass'",
              "expected": "pass"
            },
            "completeness": {
              "type": "automated",
              "command": "echo 'All 4 done_when criteria verified'",
              "expected": "All 4 done_when criteria verified"
            }
          }
        }
      ]
    }
  ],
  "final_tasks": []
}
