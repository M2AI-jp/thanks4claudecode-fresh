{
  "_template_rules": {
    "criterion": {
      "MUST": "State what must be true, not what to do",
      "MUST": "Be verifiable by command execution",
      "FORBIDDEN": ["〜する", "〜した", "確認する", "検証する", "適切", "正しく", "良い"],
      "GOOD_EXAMPLES": [
        "ファイル X が存在する",
        "jq '.field' が Y を返す",
        "grep -c 'pattern' が N 以上"
      ],
      "BAD_EXAMPLES": [
        "ファイルを作成する",
        "適切に設定されている",
        "正しく動作する"
      ]
    },
    "command": {
      "MUST": "Be a shell command that can be executed",
      "MUST": "Return verifiable output or exit code",
      "FORBIDDEN": ["Execute ...", "Compare ...", "Review ...", "Check ..."],
      "GOOD_EXAMPLES": [
        "test -f path && echo 'exists'",
        "jq -e '.field' file.json",
        "grep -c 'pattern' file | awk '{print ($1 >= 3)}'"
      ],
      "BAD_EXAMPLES": [
        "Execute the test",
        "Compare with expected",
        "Manually verify"
      ]
    },
    "expected": {
      "MUST": "Be a concrete value or condition",
      "FORBIDDEN": ["適切", "正常", "正しく", "All ...", "100% ..."],
      "GOOD_EXAMPLES": [
        "exists",
        "exit 0",
        "true",
        ">= 1",
        "\"completed\""
      ],
      "BAD_EXAMPLES": [
        "正常終了",
        "All pass",
        "100% match"
      ]
    }
  },
  "format_version": "2.2",
  "meta": {
    "id": "pb-m1-schema",
    "branch": "feat/validation-enforcement-m1",
    "created": "2026-01-20",
    "status": "completed",
    "review_profile": "standard",
    "reviewed": true,
    "reviewed_by": "reviewer",
    "roles": {
      "orchestrator": "claudecode",
      "worker": "codex",
      "reviewer": "coderabbit",
      "human": "user"
    }
  },
  "goal": {
    "summary": "validate-playbook-schema.sh スクリプトを作成し、playbook の criterion/command/expected 3点セットを検証可能にする",
    "done_when": [
      {
        "criterion": "scripts/validate-playbook-schema.sh が存在し、実行可能である",
        "command": "test -x scripts/validate-playbook-schema.sh && echo 'executable'",
        "expected": "executable"
      },
      {
        "criterion": "不正な playbook（FORBIDDEN パターン含む）を検出してエラーを返す",
        "command": "echo '{\"done_when\":[{\"criterion\":\"テストする\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR'",
        "expected": ">= 1"
      }
    ],
    "scope": {
      "includes": [
        "scripts/validate-playbook-schema.sh の新規作成",
        "_template_rules の FORBIDDEN パターン検出ロジック",
        "criterion/command/expected 3点セットの存在チェック",
        "テストケース作成"
      ],
      "excludes": [
        "他のマイルストーン（m2, m3）のスクリプト作成",
        "critic/reviewer SubAgent の修正",
        "既存 playbook の修正"
      ]
    }
  },
  "context": {
    "analysis_result": {
      "source": "prompt-analyzer",
      "data": {
        "primary_topic_type": "instruction",
        "confidence": "high",
        "5w1h": {
          "who": "Claude Code（pm SubAgent）",
          "what": "validate-playbook-schema.sh スクリプトの作成",
          "when": "即時（validation-enforcement-system プロジェクトの m1）",
          "where": "scripts/ ディレクトリ",
          "why": "playbook の criterion/command/expected 3点セットを構造的に強制するため",
          "how": "jq を使用した JSON 検証スクリプト + FORBIDDEN パターンの grep 検出",
          "missing": []
        },
        "risks": {
          "technical": [
            {
              "risk": "jq の複雑なクエリによるパフォーマンス問題",
              "severity": "low",
              "mitigation": "playbook サイズが小さいため問題なし"
            }
          ],
          "scope": [],
          "dependency": [
            {
              "risk": "jq コマンドの可用性",
              "severity": "low",
              "mitigation": "macOS/Linux 標準で利用可能"
            }
          ]
        },
        "ambiguity": [],
        "multi_topic_detection": {
          "instruction": ["validate-playbook-schema.sh スクリプト作成"],
          "question": [],
          "context": ["validation-enforcement-system プロジェクトのマイルストーン m1"]
        },
        "test_strategy": {
          "level": "unit",
          "coverage_target": "FORBIDDEN パターン全種、3点セット不完全ケース",
          "edge_cases": ["空の playbook", "一部欠落", "FORBIDDEN パターン混在"]
        },
        "preconditions": {
          "existing_code": "play/template/plan.json に _template_rules 定義済み",
          "dependencies": ["jq", "bash"],
          "constraints": ["POSIX 準拠シェルスクリプト"]
        },
        "success_criteria": {
          "functional": [
            "scripts/validate-playbook-schema.sh が実行可能",
            "FORBIDDEN パターン検出時に ERROR 出力",
            "3点セット欠落時に ERROR 出力"
          ],
          "non_functional": ["実行時間 1秒以内"],
          "breaking_changes": []
        },
        "reverse_dependencies": {
          "components": ["m2_command_execution", "m3_integration_proof"],
          "risk_level": "low"
        }
      }
    },
    "user_approved_understanding": {
      "source": "pm-subagent",
      "approved_at": "2026-01-20",
      "summary": "プロジェクト m1_schema_enforcement の playbook 作成",
      "approved_items": [
        "validate-playbook-schema.sh スクリプト作成",
        "FORBIDDEN パターン検出機能",
        "3点セット検証機能"
      ],
      "technical_requirements_confirmed": [
        "criterion: 状態記述形式",
        "command: 実行可能シェルコマンド",
        "expected: 具体値"
      ]
    }
  },
  "max_iterations": 5,
  "phases": [
    {
      "id": "p1",
      "name": "Script skeleton creation",
      "description": "validate-playbook-schema.sh の基本構造を作成し、引数解析と --stdin オプションを実装",
      "depends_on": [],
      "subtasks": [
        {
          "id": "p1.1",
          "criterion": "scripts/validate-playbook-schema.sh が存在する",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "test -f scripts/validate-playbook-schema.sh && echo 'exists'",
              "expected": "exists"
            },
            "consistency": {
              "type": "automated",
              "command": "head -1 scripts/validate-playbook-schema.sh | grep -c '#!/bin/bash'",
              "expected": ">= 1"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c '\\-\\-stdin' scripts/validate-playbook-schema.sh",
              "expected": ">= 1"
            }
          }
        },
        {
          "id": "p1.2",
          "criterion": "scripts/validate-playbook-schema.sh が実行可能パーミッションを持つ",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "test -x scripts/validate-playbook-schema.sh && echo 'executable'",
              "expected": "executable"
            },
            "consistency": {
              "type": "automated",
              "command": "ls -la scripts/validate-playbook-schema.sh | awk '{print $1}' | grep -c 'x'",
              "expected": ">= 1"
            },
            "completeness": {
              "type": "automated",
              "command": "stat -f '%Sp' scripts/validate-playbook-schema.sh 2>/dev/null || stat -c '%A' scripts/validate-playbook-schema.sh 2>/dev/null | grep -c 'x'",
              "expected": ">= 1"
            }
          }
        }
      ]
    },
    {
      "id": "p2",
      "name": "FORBIDDEN pattern detection",
      "description": "_template_rules の FORBIDDEN パターンを検出するロジックを実装",
      "depends_on": ["p1"],
      "subtasks": [
        {
          "id": "p2.1",
          "criterion": "criterion の FORBIDDEN パターン（〜する、〜した、適切、正しく、良い）を検出する",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"テストする\",\"command\":\"echo test\",\"expected\":\"test\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR.*FORBIDDEN'",
              "expected": ">= 1"
            },
            "consistency": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"ファイルが存在する\",\"command\":\"test -f x\",\"expected\":\"exit 0\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR'",
              "expected": "0"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -E '(する|した|適切|正しく|良い)' scripts/validate-playbook-schema.sh | wc -l | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
              "expected": "found"
            }
          }
        },
        {
          "id": "p2.2",
          "criterion": "command の FORBIDDEN パターン（Execute, Compare, Review, Check）を検出する",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"X\",\"command\":\"Execute test\",\"expected\":\"y\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR.*FORBIDDEN'",
              "expected": ">= 1"
            },
            "consistency": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"X\",\"command\":\"test -f x\",\"expected\":\"exit 0\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR'",
              "expected": "0"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -E '(Execute|Compare|Review|Check)' scripts/validate-playbook-schema.sh | wc -l | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
              "expected": "found"
            }
          }
        },
        {
          "id": "p2.3",
          "criterion": "expected の FORBIDDEN パターン（適切、正常、正しく、All、100%）を検出する",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"X\",\"command\":\"echo y\",\"expected\":\"正常終了\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR.*FORBIDDEN'",
              "expected": ">= 1"
            },
            "consistency": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"X\",\"command\":\"echo y\",\"expected\":\"pass\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR'",
              "expected": "0"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -E '(適切|正常|正しく|All|100%)' scripts/validate-playbook-schema.sh | wc -l | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
              "expected": "found"
            }
          }
        }
      ]
    },
    {
      "id": "p3",
      "name": "Three-point set validation",
      "description": "criterion/command/expected の3点セットが揃っているかを検証するロジックを実装",
      "depends_on": ["p1"],
      "subtasks": [
        {
          "id": "p3.1",
          "criterion": "done_when の各エントリに criterion/command/expected が全て存在することを検証する",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"X\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR.*missing'",
              "expected": ">= 1"
            },
            "consistency": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"X\",\"command\":\"echo y\",\"expected\":\"y\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR.*missing'",
              "expected": "0"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c 'criterion.*command.*expected' scripts/validate-playbook-schema.sh | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
              "expected": "found"
            }
          }
        },
        {
          "id": "p3.2",
          "criterion": "phases[].subtasks[].validation_plan の各 type に criterion/command/expected が存在することを検証する",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "echo '{\"phases\":[{\"subtasks\":[{\"validation_plan\":{\"technical\":{\"type\":\"automated\"}}}]}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR.*missing'",
              "expected": ">= 1"
            },
            "consistency": {
              "type": "automated",
              "command": "echo '{\"phases\":[{\"subtasks\":[{\"validation_plan\":{\"technical\":{\"type\":\"automated\",\"command\":\"x\",\"expected\":\"y\"}}}]}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR.*missing'",
              "expected": "0"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c 'validation_plan' scripts/validate-playbook-schema.sh | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
              "expected": "found"
            }
          }
        }
      ]
    },
    {
      "id": "p4",
      "name": "Test cases and documentation",
      "description": "テストケースを作成し、スクリプトの動作を検証する",
      "depends_on": ["p2", "p3"],
      "subtasks": [
        {
          "id": "p4.1",
          "criterion": "tests/validate-playbook-schema-test.sh が存在し、実行可能である",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "test -x tests/validate-playbook-schema-test.sh && echo 'executable'",
              "expected": "executable"
            },
            "consistency": {
              "type": "automated",
              "command": "head -1 tests/validate-playbook-schema-test.sh | grep -c '#!/bin/bash'",
              "expected": ">= 1"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c 'validate-playbook-schema.sh' tests/validate-playbook-schema-test.sh",
              "expected": ">= 1"
            }
          }
        },
        {
          "id": "p4.2",
          "criterion": "tests/validate-playbook-schema-test.sh が exit 0 で終了する",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "bash tests/validate-playbook-schema-test.sh > /dev/null 2>&1 && echo 'pass' || echo 'fail'",
              "expected": "pass"
            },
            "consistency": {
              "type": "automated",
              "command": "tests/validate-playbook-schema-test.sh 2>&1 | tail -1",
              "expected": "pass"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c 'FORBIDDEN\\|missing\\|3点セット' tests/validate-playbook-schema-test.sh | awk '{print ($1 >= 3 ? \"comprehensive\" : \"incomplete\")}'",
              "expected": "comprehensive"
            }
          }
        }
      ]
    },
    {
      "id": "p_final",
      "name": "Final verification",
      "description": "goal.done_when の全コマンドを実行し、マイルストーン完了条件を満たすことを確認",
      "depends_on": ["p4"],
      "subtasks": [
        {
          "id": "p_final.1",
          "criterion": "goal.done_when[0]: scripts/validate-playbook-schema.sh が存在し、実行可能である",
          "executor": "coderabbit",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "test -x scripts/validate-playbook-schema.sh && echo 'executable'",
              "expected": "executable"
            },
            "consistency": {
              "type": "automated",
              "command": "file scripts/validate-playbook-schema.sh | grep -c 'script'",
              "expected": ">= 1"
            },
            "completeness": {
              "type": "automated",
              "command": "scripts/validate-playbook-schema.sh --help 2>&1 | grep -c 'Usage\\|usage'",
              "expected": ">= 1"
            }
          }
        },
        {
          "id": "p_final.2",
          "criterion": "goal.done_when[1]: 不正な playbook を検出してエラーを返す",
          "executor": "coderabbit",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"テストする\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR'",
              "expected": ">= 1"
            },
            "consistency": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"Xが存在する\",\"command\":\"test -f x\",\"expected\":\"exit 0\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR'",
              "expected": "0"
            },
            "completeness": {
              "type": "automated",
              "command": "echo '{\"done_when\":[{\"criterion\":\"テストする\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -E 'FORBIDDEN|missing' | wc -l | awk '{print ($1 >= 1 ? \"detected\" : \"not_detected\")}'",
              "expected": "detected"
            }
          }
        }
      ]
    }
  ],
  "final_tasks": []
}
