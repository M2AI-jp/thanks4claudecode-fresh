{
  "_template_rules": {
    "criterion": {
      "MUST": "State what must be true, not what to do",
      "MUST": "Be verifiable by command execution",
      "FORBIDDEN": ["〜する", "〜した", "確認する", "検証する", "適切", "正しく", "良い"],
      "GOOD_EXAMPLES": [
        "ファイル X が存在する",
        "jq '.field' が Y を返す",
        "テストスクリプトが exit 0 で終了する"
      ],
      "BAD_EXAMPLES": [
        "システムを実装する",
        "適切に設定されている",
        "正しく動作する"
      ]
    },
    "command": {
      "MUST": "Be a shell command that can be executed",
      "MUST": "Return verifiable output or exit code",
      "FORBIDDEN": ["Execute ...", "Compare ...", "Review ...", "Check ...", "Verify ..."],
      "GOOD_EXAMPLES": [
        "test -f path && echo 'exists'",
        "./scripts/integration-test.sh && echo 'pass'",
        "jq -e '.status' state.json"
      ],
      "BAD_EXAMPLES": [
        "Execute all tests",
        "Verify the system works",
        "Check manually"
      ]
    },
    "expected": {
      "MUST": "Be a concrete value or condition",
      "FORBIDDEN": ["適切", "正常", "正しく", "All ...", "100% ...", "Complete"],
      "GOOD_EXAMPLES": [
        "exists",
        "pass",
        "exit 0",
        "\"completed\"",
        ">= 1"
      ],
      "BAD_EXAMPLES": [
        "正常終了",
        "All pass",
        "Complete success"
      ]
    }
  },
  "format_version": "1.2",
  "meta": {
    "id": "validation-enforcement-system",
    "title": "Validation Enforcement System: 報酬詐欺を構造的に不可能にする検証強化",
    "created": "2026-01-20",
    "status": "active",
    "reviewed": true,
    "reviewed_by": "reviewer",
    "closed_at": null,
    "closed_by": null
  },
  "goal": {
    "summary": "新しい厳密テンプレート（_template_rules 付き）を使用して検証システム全体を強化し、criterion/command/expected の3点セットを全ての検証箇所で強制することで、報酬詐欺を構造的に不可能にする",
    "done_when": [
      {
        "criterion": "統合テストスクリプト scripts/validation-enforcement-test.sh が pass を出力する",
        "command": "./scripts/validation-enforcement-test.sh 2>/dev/null | tail -1",
        "expected": "pass"
      },
      {
        "criterion": "全ての playbook が completed ステータスである",
        "command": "jq -e '[.milestones[].playbooks[] | select(.status != \"completed\")] | length' play/projects/validation-enforcement-system/project.json",
        "expected": "0"
      },
      {
        "criterion": "critic SubAgent が新形式（3点セット）で検証を実行する",
        "command": "grep -c 'criterion.*command.*expected' .claude/skills/quality-assurance/agents/critic.md | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
        "expected": "found"
      }
    ]
  },
  "milestones": [
    {
      "id": "m1_schema_enforcement",
      "title": "Milestone 1: Schema Enforcement - テンプレートの構造検証",
      "order": 1,
      "status": "completed",
      "description": "_template_rules の実行時チェック機構を構築し、criterion/command/expected の3点セットを強制する",
      "done_when": [
        {
          "criterion": "scripts/validate-playbook-schema.sh が存在し、実行可能である",
          "command": "test -x scripts/validate-playbook-schema.sh && echo 'executable'",
          "expected": "executable"
        },
        {
          "criterion": "不正な playbook を検出してエラーを返す",
          "command": "echo '{\"done_when\":[{\"criterion\":\"テストする\"}]}' | scripts/validate-playbook-schema.sh --stdin 2>&1 | grep -c 'ERROR'",
          "expected": ">= 1"
        }
      ],
      "playbooks": [
        {
          "id": "pb-m1-schema",
          "title": "Schema validation script implementation",
          "status": "completed",
          "path": "play/projects/validation-enforcement-system/playbooks/pb-m1-schema/plan.json"
        }
      ]
    },
    {
      "id": "m2_command_execution",
      "title": "Milestone 2: Command Execution - done_when/validation_plan の command が実行可能",
      "order": 2,
      "status": "pending",
      "description": "全ての done_when と validation_plan の command が実際に実行可能であることを保証するシステムを構築",
      "done_when": [
        {
          "criterion": "scripts/validate-commands.sh が存在し、実行可能である",
          "command": "test -x scripts/validate-commands.sh && echo 'executable'",
          "expected": "executable"
        },
        {
          "criterion": "playbook 内の全 command が構文エラーなしでパース可能",
          "command": "scripts/validate-commands.sh play/template/plan.json 2>&1 | tail -1",
          "expected": "pass"
        }
      ],
      "playbooks": [
        {
          "id": "pb-m2-commands",
          "title": "Command validation and execution system",
          "status": "pending",
          "path": "play/projects/validation-enforcement-system/playbooks/pb-m2-commands/plan.json"
        }
      ]
    },
    {
      "id": "m3_integration_proof",
      "title": "Milestone 3: Integration Proof - critic/reviewer が新形式を正しく検証",
      "order": 3,
      "status": "pending",
      "description": "critic と reviewer SubAgent が新形式（criterion/command/expected）を正しく検証することを確認",
      "done_when": [
        {
          "criterion": "critic.md に 3点セット検証ロジックが記載されている",
          "command": "grep -c 'criterion.*command.*expected' .claude/skills/quality-assurance/agents/critic.md | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
          "expected": "found"
        },
        {
          "criterion": "reviewer.md に 3点セット検証ロジックが記載されている",
          "command": "grep -c 'criterion.*command.*expected' .claude/skills/quality-assurance/agents/reviewer.md | awk '{print ($1 >= 1 ? \"found\" : \"not_found\")}'",
          "expected": "found"
        },
        {
          "criterion": "統合テストが pass を返す",
          "command": "./scripts/validation-enforcement-test.sh 2>/dev/null | tail -1",
          "expected": "pass"
        }
      ],
      "playbooks": [
        {
          "id": "pb-m3-integration",
          "title": "Critic/Reviewer integration with new format",
          "status": "pending",
          "path": "play/projects/validation-enforcement-system/playbooks/pb-m3-integration/plan.json"
        }
      ]
    }
  ],
  "progress": {
    "total_playbooks": 3,
    "completed_playbooks": 1,
    "current_milestone": "m2_command_execution",
    "current_playbook": null
  },
  "context": {
    "analysis_result": {
      "source": "prompt-analyzer",
      "data": {
        "primary_topic_type": "instruction",
        "confidence": "high",
        "5w1h": {
          "who": "開発者（Claude Code）",
          "what": "validation-enforcement-system プロジェクトの作成",
          "when": "即時（直前の template-strictness-v2 完了後）",
          "where": "play/projects/ ディレクトリ配下",
          "why": "報酬詐欺を構造的に不可能にする検証システムの強化",
          "how": "_template_rules 付きの新テンプレートを使用したプロジェクト作成",
          "missing": []
        },
        "risks": {
          "technical": [
            {
              "risk": "_template_rules の実行時チェック機構の複雑性",
              "severity": "medium",
              "mitigation": "段階的な m1/m2/m3 マイルストーンで検証"
            }
          ],
          "dependency": [
            {
              "risk": "critic/reviewer SubAgent の新形式対応",
              "severity": "high",
              "mitigation": "m3 で明示的に検証"
            }
          ]
        },
        "success_criteria": {
          "functional": [
            "全 playbook が新テンプレート形式（criterion/command/expected）に準拠",
            "validation コマンドの自動実行システムが機能",
            "報酬詐欺を検出するテストケースが存在し PASS"
          ]
        },
        "ready_for_playbook": true,
        "blocking_issues": []
      }
    },
    "user_approved_understanding": {
      "source": "user",
      "approved_at": "2026-01-20",
      "summary": "プロジェクト作成を承認（既存プロジェクトは完了済みと確認）",
      "approved_items": [
        "m1_schema_enforcement: テンプレートの構造検証",
        "m2_command_execution: command 実行可能性保証",
        "m3_integration_proof: critic/reviewer 統合検証"
      ],
      "technical_requirements_confirmed": [
        "criterion/command/expected の3点セット強制",
        "_template_rules による実行時チェック",
        "報酬詐欺の構造的防止"
      ]
    }
  }
}
