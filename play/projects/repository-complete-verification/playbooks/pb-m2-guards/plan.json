{
  "format_version": "2.4",
  "meta": {
    "id": "pb-m2-guards",
    "branch": "feat/repository-complete-verification",
    "created": "2026-01-28",
    "status": "draft",
    "review_profile": "standard",
    "reviewed": false,
    "reviewed_by": "",
    "roles": {
      "orchestrator": "claudecode",
      "worker": "codex",
      "reviewer": "coderabbit",
      "human": "user"
    }
  },
  "goal": {
    "summary": "Verify all 15 Guard systems function correctly with BLOCK/ALLOW behavior",
    "done_when": [
      {
        "criterion": "15 Guard スクリプト全てが存在する",
        "command": "find .claude -name '*guard*.sh' -o -name 'bash-check.sh' -o -name 'role-resolver.sh' -o -name 'coherence.sh' -o -name 'completion-check.sh' -o -name 'progress-reminder.sh' -o -name 'protected-edit.sh' -o -name 'depends-check.sh' | wc -l | tr -d ' '",
        "expected": ">= 15"
      },
      {
        "criterion": "全 Guard が正しい exit code を返す（BLOCK=2, ALLOW=0）",
        "command": "bash scripts/guard-test.sh 2>/dev/null; echo $?",
        "expected": "0"
      }
    ],
    "scope": {
      "includes": [
        "bash-check.sh",
        "protected-edit.sh",
        "playbook-guard.sh",
        "depends-check.sh",
        "executor-guard.sh",
        "role-resolver.sh",
        "critic-guard.sh",
        "subtask-guard.sh",
        "phase-status-guard.sh",
        "scope-guard.sh",
        "coherence.sh",
        "completion-check.sh",
        "progress-reminder.sh",
        "pending-guard.sh",
        "init-guard.sh"
      ],
      "excludes": []
    }
  },
  "context": {
    "analysis_result": {
      "source": "prompt-analyzer",
      "data": {
        "primary_topic_type": "instruction",
        "confidence": "high"
      }
    },
    "user_approved_understanding": {
      "source": "user",
      "approved_at": "2026-01-28T19:10:00Z",
      "summary": "Verify 15 Guards with BLOCK/ALLOW testing"
    }
  },
  "max_iterations": 5,
  "phases": [
    {
      "id": "p1",
      "name": "Guard Inventory",
      "description": "Create inventory of all Guard scripts and verify existence",
      "depends_on": [],
      "subtasks": [
        {
          "id": "p1.1",
          "criterion": "Guard リスト（15件）が docs/guard-inventory.md に記録されている",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "test -f docs/guard-inventory.md && grep -c '^| ' docs/guard-inventory.md",
              "expected": ">= 15"
            },
            "consistency": {
              "type": "automated",
              "command": "grep -c 'guard\\|check\\|resolver' docs/guard-inventory.md",
              "expected": ">= 15"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c '\\.sh' docs/guard-inventory.md",
              "expected": ">= 15"
            }
          }
        }
      ]
    },
    {
      "id": "p2",
      "name": "BLOCK Behavior Test",
      "description": "Test that guards return exit 2 for BLOCK conditions",
      "depends_on": ["p1"],
      "subtasks": [
        {
          "id": "p2.1",
          "criterion": "playbook-guard.sh が playbook=null で exit 2 を返す",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "echo '{\"tool_input\":{\"file_path\":\"test.md\"}}' | PLAYBOOK_ACTIVE=null bash .claude/skills/playbook-gate/guards/playbook-guard.sh 2>/dev/null; echo $?",
              "expected": "2"
            },
            "consistency": {
              "type": "automated",
              "command": "grep -c 'exit 2' .claude/skills/playbook-gate/guards/playbook-guard.sh",
              "expected": ">= 1"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c 'BLOCK' .claude/skills/playbook-gate/guards/playbook-guard.sh",
              "expected": ">= 1"
            }
          }
        }
      ]
    },
    {
      "id": "p3",
      "name": "Guard Test Script Creation",
      "description": "Create comprehensive guard test script",
      "depends_on": ["p2"],
      "subtasks": [
        {
          "id": "p3.1",
          "criterion": "scripts/guard-test.sh が存在し全 Guard をテストする",
          "executor": "codex",
          "coding": true,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "test -f scripts/guard-test.sh && bash -n scripts/guard-test.sh && echo 'VALID'",
              "expected": "VALID"
            },
            "consistency": {
              "type": "automated",
              "command": "grep -c 'guard' scripts/guard-test.sh",
              "expected": ">= 10"
            },
            "completeness": {
              "type": "automated",
              "command": "grep -c 'echo.*PASS\\|echo.*FAIL' scripts/guard-test.sh",
              "expected": ">= 5"
            }
          }
        }
      ]
    },
    {
      "id": "p_final",
      "name": "Final Verification",
      "description": "Run guard-test.sh and verify all tests pass",
      "depends_on": ["p3"],
      "subtasks": [
        {
          "id": "p_final.1",
          "criterion": "scripts/guard-test.sh が exit 0 で終了する",
          "executor": "coderabbit",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "automated",
              "command": "bash scripts/guard-test.sh 2>/dev/null; echo $?",
              "expected": "0"
            },
            "consistency": {
              "type": "automated",
              "command": "bash scripts/guard-test.sh 2>&1 | grep -c 'PASS'",
              "expected": ">= 10"
            },
            "completeness": {
              "type": "automated",
              "command": "bash scripts/guard-test.sh 2>&1 | grep -c 'FAIL' || echo 0",
              "expected": "0"
            }
          }
        }
      ]
    }
  ],
  "final_tasks": []
}
