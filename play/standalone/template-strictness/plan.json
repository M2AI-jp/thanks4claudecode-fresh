{
  "format_version": "2.0",
  "meta": {
    "id": "template-strictness",
    "branch": "feat/template-strictness",
    "created": "2026-01-20",
    "status": "active",
    "review_profile": "standard",
    "reviewed": true,
    "reviewed_by": "reviewer",
    "roles": {
      "orchestrator": "claudecode",
      "worker": "codex",
      "reviewer": "coderabbit",
      "human": "user"
    }
  },
  "goal": {
    "summary": "テンプレート修正（validation_plan と done_when の構造化）: 曖昧な文字列形式を { type, command, expected } 構造に変換し、報酬詐欺を防止する",
    "done_when": [
      {
        "criterion": "plan.json の validation_plan が { type, command, expected } 構造を持つ",
        "command": "jq -e '.phases[].subtasks[].validation_plan.technical | has(\"command\") and has(\"expected\")' play/template/plan.json",
        "expected": "exit 0"
      },
      {
        "criterion": "project.json の done_when が { criterion, command, expected } 構造を持つ",
        "command": "jq -e '.goal.done_when[0] | has(\"criterion\") and has(\"command\") and has(\"expected\")' play/projects/template/project.json",
        "expected": "exit 0"
      },
      {
        "criterion": "全フィールドに具体的なサンプルコマンドが記載されている",
        "command": "jq -e '.phases[].subtasks[].validation_plan.technical.command | length > 0' play/template/plan.json",
        "expected": "exit 0"
      }
    ],
    "scope": {
      "includes": [
        "play/template/plan.json の validation_plan 構造化",
        "play/template/progress.json の validations 構造化",
        "play/projects/template/project.json の done_when 構造化"
      ],
      "excludes": [
        "既存 playbook のマイグレーション（別タスク）",
        "pm.md の修正（このタスクでは対象外）"
      ]
    }
  },
  "context": {
    "analysis_result": {
      "source": "prompt-analyzer",
      "data": {
        "5w1h": {
          "who": "Claude Code システム",
          "what": "テンプレート修正（validation_plan と done_when の構造化）",
          "when": "即時",
          "where": "play/template/plan.json, progress.json, play/projects/template/project.json",
          "why": "曖昧な文字列形式が報酬詐欺を可能にしている",
          "how": "{ type, command, expected } 構造への変換"
        },
        "risks": [],
        "ambiguity": [],
        "summary": {
          "primary_topic_type": "instruction",
          "confidence": "high",
          "ready_for_playbook": true,
          "blocking_issues": []
        }
      }
    },
    "user_approved_understanding": {
      "source": "understanding-check",
      "approved_at": "2026-01-20",
      "summary": "AUTO_APPROVED",
      "approved_items": [
        "validation_plan を { type, command, expected } 構造に変換",
        "done_when を { criterion, command, expected } 構造に変換",
        "具体的なサンプルコマンドを記載"
      ],
      "technical_requirements_confirmed": [
        "jq コマンドで構造検証可能"
      ]
    }
  },
  "max_iterations": 5,
  "phases": [
    {
      "id": "p1",
      "name": "plan.json validation_plan 構造化",
      "description": "plan.json の validation_plan を { type, command, expected } 構造に変換する",
      "depends_on": [],
      "subtasks": [
        {
          "id": "p1.1",
          "criterion": "plan.json の validation_plan.technical が { type, command, expected } 構造である",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "command",
              "command": "jq -e '.phases[].subtasks[].validation_plan.technical | has(\"type\") and has(\"command\") and has(\"expected\")' play/template/plan.json",
              "expected": "exit 0"
            },
            "consistency": {
              "type": "command",
              "command": "jq -e '.phases[].subtasks[].validation_plan | (.technical and .consistency and .completeness)' play/template/plan.json",
              "expected": "exit 0 (全3項目が存在)"
            },
            "completeness": {
              "type": "command",
              "command": "jq '.phases[].subtasks[].validation_plan.technical.command' play/template/plan.json | grep -v 'null'",
              "expected": "具体的なコマンド文字列が出力される"
            }
          }
        },
        {
          "id": "p1.2",
          "criterion": "plan.json の validation_plan.consistency と validation_plan.completeness が { type, command, expected } 構造である",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "command",
              "command": "jq -e '.phases[].subtasks[].validation_plan.consistency | has(\"type\") and has(\"command\") and has(\"expected\")' play/template/plan.json",
              "expected": "exit 0"
            },
            "consistency": {
              "type": "command",
              "command": "jq -e '.phases[].subtasks[].validation_plan.completeness | has(\"type\") and has(\"command\") and has(\"expected\")' play/template/plan.json",
              "expected": "exit 0"
            },
            "completeness": {
              "type": "manual",
              "command": "目視確認",
              "expected": "technical/consistency/completeness の3項目全てが新形式"
            }
          }
        }
      ]
    },
    {
      "id": "p2",
      "name": "progress.json validations 構造化",
      "description": "progress.json の validations.*.evidence 形式を維持しつつ、plan との整合性を確認",
      "depends_on": ["p1"],
      "subtasks": [
        {
          "id": "p2.1",
          "criterion": "progress.json の validations 構造が plan.json と整合している",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "command",
              "command": "jq -e '.subtasks[].validations | has(\"technical\") and has(\"consistency\") and has(\"completeness\")' play/template/progress.json",
              "expected": "exit 0"
            },
            "consistency": {
              "type": "command",
              "command": "jq -e '.subtasks[].validations.technical | has(\"status\") and has(\"evidence\")' play/template/progress.json",
              "expected": "exit 0"
            },
            "completeness": {
              "type": "manual",
              "command": "目視確認",
              "expected": "progress.json が plan.json の validation_plan と対応している"
            }
          }
        }
      ]
    },
    {
      "id": "p3",
      "name": "project.json done_when 構造化",
      "description": "project.json の done_when を { criterion, command, expected } 構造に変換する",
      "depends_on": ["p1"],
      "subtasks": [
        {
          "id": "p3.1",
          "criterion": "project.json の done_when が { criterion, command, expected } 構造である",
          "executor": "claudecode",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "command",
              "command": "jq -e '.goal.done_when[0] | has(\"criterion\") and has(\"command\") and has(\"expected\")' play/projects/template/project.json",
              "expected": "exit 0"
            },
            "consistency": {
              "type": "command",
              "command": "jq -e '.goal.done_when | length > 0' play/projects/template/project.json",
              "expected": "exit 0"
            },
            "completeness": {
              "type": "command",
              "command": "jq '.goal.done_when[].command' play/projects/template/project.json | grep -v 'null'",
              "expected": "具体的なコマンド文字列が出力される"
            }
          }
        }
      ]
    },
    {
      "id": "p_final",
      "name": "Final review",
      "description": "全 done_when 条件の独立検証",
      "depends_on": ["p1", "p2", "p3"],
      "subtasks": [
        {
          "id": "p_final.1",
          "criterion": "全 done_when 条件が PASS している",
          "executor": "coderabbit",
          "coding": false,
          "validation_plan": {
            "technical": {
              "type": "command",
              "command": "jq -e '.phases[].subtasks[].validation_plan.technical | has(\"command\") and has(\"expected\")' play/template/plan.json && jq -e '.goal.done_when[0] | has(\"criterion\") and has(\"command\") and has(\"expected\")' play/projects/template/project.json",
              "expected": "exit 0"
            },
            "consistency": {
              "type": "command",
              "command": "jq -e '.phases[].subtasks[].validation_plan.technical.command | length > 0' play/template/plan.json",
              "expected": "exit 0"
            },
            "completeness": {
              "type": "manual",
              "command": "done_when の全項目を実行して確認",
              "expected": "3つの done_when 条件が全て PASS"
            }
          }
        }
      ]
    }
  ],
  "final_tasks": []
}
