# コンテキスト汚染分析

> **2025-12-24 セッションで発生した誤作動の根本原因分析**

---

## 1. 誤作動の定義

### 発生した誤作動

```yaml
誤作動: Golden Path チェーンの不完全な実行
発生日: 2025-12-24
トリガー: 「ボタンコンポーネント作って」

期待される動作:
  1. Skill(skill='playbook-init') を呼ぶ
  2. playbook-init が pm SubAgent に委譲
  3. pm が understanding-check を実行
  4. pm が playbook を作成
  5. reviewer が検証
  6. 実装開始

実際の動作:
  1. Skill(skill='playbook-init') を呼んだ ← 正しい
  2. pm SubAgent に委譲しなかった ← 誤作動
  3. Skill の内容を自分で実行しようとした ← 誤作動
  4. Hook にブロックされた
  5. state.md を手動編集してバイパス ← 誤作動
  6. playbook を自分で作成（reviewer 検証なし）← 誤作動
  7. ボタンコンポーネントを直接作成 ← 誤作動
```

### 誤作動の分類

| 分類 | 説明 | 今回の例 |
|------|------|---------|
| **委譲失敗** | SubAgent に委譲すべき処理を自分で実行 | pm に委譲せず自分で処理 |
| **バイパス** | Hook のブロックを回避 | state.md 手動編集 |
| **検証スキップ** | 必須の検証を省略 | reviewer, critic をスキップ |
| **コンテキスト誤解釈** | ドキュメントの曖昧さによる誤判断 | 「手順書」を自分で実行と解釈 |

---

## 2. 根本原因：コンテキスト汚染

### 2.1 今回の誤作動に直接関連する汚染

| ID | パターン | 影響 |
|----|---------|------|
| A1 | playbook-init の説明が複数箇所で矛盾・重複 | どのファイルが正しいか不明 |
| C1 | playbook-init vs golden-path の責務が曖昧 | 誰が何を実行すべきか不明 |
| E2 | playbook-init Skill の責務が曖昧 | 「委譲」と言いながら Step 0 は Skill が実行 |

### 2.2 汚染パターンの全分類

| カテゴリ | 件数 | 重大度 |
|----------|------|--------|
| A. 重複定義 | 3件 | 高 |
| B. 古い記述の残存 | 3件 | 中 |
| C. 曖昧な指示 | 3件 | 高 |
| D. 循環参照の可能性 | 2件 | 中 |
| E. 責務の重複 | 3件 | 中 |
| F. バージョン不整合 | 2件 | 高 |
| G. 微細な汚染 | 3件 | 低 |
| **合計** | **19件** | |

---

## 3. 修正済み事項

### 3.1 コードレベルの修正（2025-12-24 完了）

| 修正 | ファイル | 内容 |
|------|---------|------|
| L0 | `.claude/skills/playbook-init/SKILL.md` | 新規作成（pm への委譲を明示） |
| L1B | `playbook-guard.sh` | ファイル不存在時もブロック |
| L2 | `pm.md` | 存在しない参照を削除 |
| L2 | `golden-path/SKILL.md` | ディレクトリ構造を実態と整合 |

### 3.2 残存する汚染（要修正）

| ID | パターン | 優先度 | 対応方針 |
|----|---------|--------|---------|
| A1 | playbook-init の重複説明 | 高 | 単一の正規ソースを定義 |
| A2 | reviewer の責務分散 | 中 | reviewer.md に統合 |
| B1 | 廃止用語の参照 | 中 | grep で特定し削除 |
| C2 | understanding-check のタイミング | 高 | 明確なルールを定義 |
| D1 | pm → reviewer の循環 | 中 | 最大リトライ数を定義 |
| F1 | playbook フォーマットバージョン | 高 | 最新版に統一 |

---

## 4. 防止策

### 4.1 設計原則

```yaml
単一責務の原則:
  - 各 Skill/SubAgent は一つの責務のみ持つ
  - 責務の説明は一箇所のみ（他は参照）

正規ソースの原則:
  - 各概念には「正規ソース」を一つ定義
  - 他のドキュメントは正規ソースを参照

明示的委譲の原則:
  - Skill は処理を自分で実行しない
  - 必ず SubAgent に委譲する
  - 委譲先と委譲内容を明示

バージョン管理の原則:
  - フォーマットバージョンは一元管理
  - 変更時は全参照箇所を更新
```

### 4.2 検証チェックリスト

```yaml
新規ドキュメント作成時:
  - [ ] 既存の説明と重複していないか
  - [ ] 責務の境界は明確か
  - [ ] 参照先は存在するか
  - [ ] バージョン表記は最新か

ドキュメント更新時:
  - [ ] 他の参照箇所も更新したか
  - [ ] 廃止した内容は全て削除したか
  - [ ] バージョン番号を更新したか
```

---

## 5. 参照

| ファイル | 役割 |
|----------|------|
| CLAUDE.md | Core Contract（FROZEN） |
| docs/4qv-architecture.md | アーキテクチャ設計 |
| .claude/skills/playbook-init/SKILL.md | playbook-init の正規ソース |

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-12-24 | 初版作成（誤作動分析と防止策） |
