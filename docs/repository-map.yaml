# Repository Map
#
# リポジトリ内の全ファイルマッピング（自動生成）
#
# 生成スクリプト: .claude/hooks/generate-repository-map.sh
# 更新タイミング: playbook 完了時
#
# このファイルは自動生成されます。手動編集は上書きされます。

meta:
  generated: "2025-12-24 01:09:04"
  generator: ".claude/hooks/generate-repository-map.sh"
  total_files: 307

hooks:
  directory: .claude/hooks/
  count: 31
  files:
    - name: "archive-playbook.sh"
    - name: "audit-unused.sh"
    - name: "check-coherence.sh"
    - name: "check-integrity.sh"
    - name: "check-main-branch.sh"
    - name: "check-protected-edit.sh"
    - name: "cleanup-hook.sh"
    - name: "create-pr-hook.sh"
    - name: "create-pr.sh"
    - name: "critic-guard.sh"
    - name: "depends-check.sh"
    - name: "executor-guard.sh"
    - name: "failure-logger.sh"
    - name: "generate-repository-map.sh"
    - name: "init-guard.sh"
    - name: "lint-check.sh"
    - name: "log-subagent.sh"
    - name: "merge-pr.sh"
    - name: "playbook-guard.sh"
    - name: "pre-bash-check.sh"
    - name: "pre-compact.sh"
    - name: "prompt-guard.sh"
    - name: "role-resolver.sh"
    - name: "scope-guard.sh"
    - name: "session-end.sh"
    - name: "session-start.sh"
    - name: "stop-summary.sh"
    - name: "subtask-guard.sh"
    - name: "system-health-check.sh"
    - name: "test-done-criteria.sh"
    - name: "test-hooks.sh"

agents:
  directory: .claude/agents/
  count: 3
  files:
    - name: "codex-delegate"
      description: "Codex MCP をラップし、コンテキスト膨張を防止する SubAgent"
    - name: "health-checker"
      description: "description: システム状態の定期監視。state.md/playbook の整合性、git 状態、ファイル存在確認などを行う。"
    - name: "setup-guide"
      description: "description: AUTOMATICALLY guides setup process when focus.current=setup. Conducts hearing, environm"

skills:
  directory: .claude/skills/
  invocation: "Claude が文脈から自動検出して Skill ツールで呼び出す"
  usage: "プロンプトにマッチしたら発火。モデル主導で判断。"
  auto_invoke: true
  count: 13
  files:
    - name: "completion-review"
      description: "playbook 完了時の検証とアーカイブを管理する"
      structure:
        hooks: 1
        frameworks: 1
    - name: "context-management"
      description: "チャット履歴に依存しない状態管理。プロンプト→意図→処理→結果を外部ファイルに記録。"
    - name: "deploy-checker"
      description: "デプロイ準備・検証専門スキル"
    - name: "frontend-design"
      description: "プロダクション品質のフロントエンドインターフェースを作成する"
    - name: "lint-checker"
      description: "コード品質チェック専門スキル"
    - name: "phase-critique"
      description: "Phase 完了時の critic 評価を構造的に強制する"
      structure:
        hooks: 1
        agents: 1
        frameworks: 1
    - name: "plan-management"
      description: "description: Playbook management. Use when creating playbooks or transitioning phases. Triggers on \""
      structure:
        agents: 1
    - name: "playbook-review"
      description: "playbook 作成後のレビューを構造的に強制する"
      structure:
        hooks: 1
        agents: 1
        frameworks: 1
    - name: "post-loop"
      description: "POST_LOOP - playbook 完了後の自動処理"
    - name: "state"
      description: "description: このワークスペースの state.md 管理、playbook 運用の専門知識。state.md の更新、focus の切り替え、done_criteria の判定、CRIT"
      structure:
        hooks: 2
    - name: "subtask-review"
      description: "subtask 完了時の 3 点検証を構造的に強制する"
      structure:
        hooks: 1
        frameworks: 1
    - name: "test-runner"
      description: "テスト実行・検証専門スキル"
    - name: "understanding-check"
      description: "description: タスク依頼時の理解確認システム（5W1H）。playbook 作成前にユーザーの意図を確認し、リスク分析と不明点の洗い出しを行う。pm SubAgent から呼び出される。"
      structure:
        hooks: 1

commands:
  directory: .claude/commands/
  count: 8
  invocation: "ユーザーが /command で明示的に呼び出す（例: /test, /lint）"
  usage: "即座に実行される CLI 機能。ユーザーの意図を明確に反映。"
  files:
    - name: "/crit"
      description: "allowed-tools: Read, Grep, Bash"
    - name: "/focus"
      description: "allowed-tools: Read, Edit, Bash"
    - name: "/lint"
      description: "allowed-tools: Read, Bash"
    - name: "/playbook-init"
      description: "このフローは構造的に強制される。手順をスキップしてはならない。"
    - name: "/rollback"
      description: "allowed-tools: Read, Bash"
    - name: "/state-rollback"
      description: "allowed-tools: Read, Write, Bash"
    - name: "/task-start"
      description: "標準タスク開始コマンド。pm SubAgent を呼び出して playbook を作成する。"
    - name: "/test"
      description: "allowed-tools: Read, Bash"

docs:
  directory: docs/
  count: 18
  files:
    - name: "admin-contract.md"
      description: "admin は「全てをバイパス」ではなく「運用上必要な最小操作を許可」する限定権限"
    - name: "ai-orchestration.md"
      description: "役割ベース executor 抽象化 - playbook の再利用性向上"
    - name: "ARCHITECTURE.md"
      description: "リポジトリの構造と各コンポーネントの関係を文書化"
    - name: "archive-operation-rules.md"
      description: "目的"
    - name: "artifact-management-rules.md"
      description: "目的"
    - name: "core-contract.md"
      description: "この契約は admin モードでも回避不可。Hooks により構造的に強制される。"
    - name: "criterion-validation-rules.md"
      description: "criterion（done_criteria の単位）の検証ルール"
    - name: "current-definitions.md"
      description: "> このファイルは「古い表記」を特定するための基準を定義する。"
    - name: "design-philosophy.md"
      description: "Claude Code ワークスペースにおける拡張システムの設計思想を定義"
    - name: "extension-system.md"
      description: "公式リファレンスに基づく発火タイミング・トリガー・連携の完全ガイド"
    - name: "folder-management.md"
      description: "全フォルダの役割、テンポラリ/永続区分、削除タイミングを定義"
    - name: "git-operations.md"
      description: "設計方針"
    - name: "hook-responsibilities.md"
      description: "各 Hook の単一責任を明示（SOLID 原則: Single Responsibility Principle）"
    - name: "orchestration-contract.md"
      description: "ツールスタック構成と役割分担のルールを定義する契約"
    - name: "repository-structure.md"
      description: "> repository-map.yaml を活用したリポジトリ構造の理解ガイド"
    - name: "session-management.md"
      description: "M023: セッション管理ガイド - Named Sessions と Plan Mode の活用"
    - name: "toolstack-patterns.md"
      description: "3 つのツールスタックパターンと設定ガイド"

plan:
  directory: plan/
  subdirectories:
    active:
      description: "進行中の playbook"
      count: 0
    archive:
      description: "完了した playbook のアーカイブ"
      count: 112
    template:
      description: "playbook テンプレート"
      count: 5

root:
  description: "ルートディレクトリの主要ファイル"
  files:
    - name: "CLAUDE.md"
      description: "This file is the immutable operating constitution for Claude in this repository."
    - name: "AGENTS.md"
      description: "このファイルは純粋なコーディングルール。"
    - name: "README.md"
      description: "Claude Code の自律性と品質を向上させるフレームワーク"
    - name: "state.md"
      description: "現在地を示す Single Source of Truth"
    - name: ".gitignore"
      description: ""
    - name: ".mcp.json"
      description: ""

# ==============================================================================
# System Specification (M025)
# Claude の行動ルールの Single Source of Truth
# 注: フロー詳細は workflows セクション参照（M027 MECE 統一）
# ==============================================================================

system_specification:
  description: "Claude の行動ルールの Single Source of Truth"
  note: "init_flow/loop_flow/post_loop_flow は workflows セクションに統一（MECE）"

  behavior_rules:
    description: "CLAUDE.md から抽出した行動ルール"
    core_principles:
      - "pdca_autonomy: playbook 完了 → 次 playbook 自動作成"
      - "tdd_first: done_criteria = テスト仕様、根拠必須"
      - "validation: critic は frameworks/ を参照"
      - "plan_based: playbook=null で Edit/Write → ブロック"
      - "git_branch_sync: 1 playbook = 1 branch"
    mandatory_outputs:
      - "[自認]: セッション開始時"
    prohibited_actions:
      - (抽出失敗)

# ==============================================================================
# Hook Trigger Sequence (M027)
# 公式ドキュメント準拠の発火順序
# https://code.claude.com/docs/ja/hooks
# ==============================================================================

hook_trigger_sequence:
  description: "Hook の発火順序（公式ドキュメント準拠）"
  order_reference: "SessionStart → UserPromptSubmit → PreToolUse → PostToolUse → Stop → PreCompact → SessionEnd"
  triggers:
    - trigger: "SessionStart"
      description: "セッション開始時に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "session-start.sh"
              description: "session-start.sh - LLMの自己認識を形成し、LOOPを開始させる"
    - trigger: "UserPromptSubmit"
      description: "ユーザープロンプト送信時に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "prompt-guard.sh"
              description: "prompt-guard.sh - UserPromptSubmit Hook"
    - trigger: "PreToolUse"
      description: "ツール実行前に発火（matcher でフィルタ可能）"
      matchers:
        - matcher: "*"
          hooks:
            - script: "init-guard.sh"
              description: "init-guard.sh - セッション開始時の強制的自己認識ガード"
            - script: "check-main-branch.sh"
              description: "check-main-branch.sh - main ブランチでの作業をブロック"
        - matcher: "Bash"
          hooks:
            - script: "pre-bash-check.sh"
              description: "pre-bash-check.sh - Bash コマンド実行前の契約チェック"
            - script: "check-coherence.sh"
              description: "check-coherence.sh - 簡略版：state.md と playbook の整合性チェック"
            - script: "lint-check.sh"
              description: "lint-check.sh - 静的解析チェック Hook"
        - matcher: "Edit"
          hooks:
            - script: "check-protected-edit.sh"
              description: "check-protected-edit.sh - 保護対象ファイルの編集をブロック"
            - script: "playbook-guard.sh"
              description: "playbook-guard.sh - Edit/Write 時に playbook=null ならブロック"
            - script: "playbook-review-trigger.sh"
              description: ""
            - script: "depends-check.sh"
              description: "depends-check.sh - Phase の depends_on を検証"
            - script: "critic-guard.sh"
              description: "critic-guard.sh - state: done への変更を構造的にブロック"
            - script: "critic-enforcer.sh"
              description: ""
            - script: "scope-guard.sh"
              description: "scope-guard.sh - done_criteria/done_when の無断変更を検出"
            - script: "executor-guard.sh"
              description: "executor-guard.sh - Phase の executor を構造的に強制"
            - script: "subtask-guard.sh"
              description: "subtask-guard.sh - subtask の 3 検証を強制（V12: チェックボックス形式対応）"
            - script: "subtask-validator.sh"
              description: ""
        - matcher: "Write"
          hooks:
            - script: "check-protected-edit.sh"
              description: "check-protected-edit.sh - 保護対象ファイルの編集をブロック"
            - script: "playbook-guard.sh"
              description: "playbook-guard.sh - Edit/Write 時に playbook=null ならブロック"
            - script: "playbook-review-trigger.sh"
              description: ""
            - script: "critic-guard.sh"
              description: "critic-guard.sh - state: done への変更を構造的にブロック"
            - script: "scope-guard.sh"
              description: "scope-guard.sh - done_criteria/done_when の無断変更を検出"
            - script: "executor-guard.sh"
              description: "executor-guard.sh - Phase の executor を構造的に強制"
            - script: "subtask-guard.sh"
              description: "subtask-guard.sh - subtask の 3 検証を強制（V12: チェックボックス形式対応）"
    - trigger: "PostToolUse"
      description: "ツール実行後に発火（matcher でフィルタ可能）"
      matchers:
        - matcher: "Edit"
          hooks:
            - script: "archive-playbook.sh"
              description: "archive-playbook.sh - playbook 完了時の自動アーカイブ提案"
            - script: "archive-validator.sh"
              description: ""
            - script: "cleanup-hook.sh"
              description: "cleanup-hook.sh - playbook 完了時のテンポラリファイル自動クリーンアップ"
            - script: "create-pr-hook.sh"
              description: "create-pr-hook.sh - playbook 完了時の PR 自動作成 + マージフック"
        - matcher: "Task"
          hooks:
            - script: "log-subagent.sh"
              description: "log-subagent.sh - Subagent 発動ログ記録 + critic 結果処理"
    - trigger: "Stop"
      description: "セッション中断時（Ctrl+C, /stop）に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "stop-summary.sh"
              description: "stop-summary.sh - Stop Hook: Phase 状態サマリー + 整合性チェック"
    - trigger: "PreCompact"
      description: "コンテキスト圧縮前に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "pre-compact.sh"
              description: "pre-compact.sh - PreCompact Hook: 完全な状態スナップショット保存"
    - trigger: "SessionEnd"
      description: "セッション終了時に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "session-end.sh"
              description: "session-end.sh - セッション終了時に四つ組整合性チェック + リマインド"

# ==============================================================================
# Workflows (M027)
# 組み合わせモジュール単位でシステム構造を整理
# ==============================================================================

workflows:
  description: "複数コンポーネントが連携して1つの機能を実現する組み合わせモジュール"
  modules:

    - id: init_flow
      name: "INIT"
      why: |
        LLM は状態を保持しないため、毎セッション開始時に現在地を再認識する必要がある。
        state.md/playbook の強制読み込みにより、コンテキストを確実に復元する。
      when: "SessionStart 発火時"
      input:
        - "ユーザーの最初のプロンプト"
        - "state.md（focus, playbook, goal）"
        - "playbook（active な場合）"
      process:
        hooks:
          - "session-start.sh: pending 作成、失敗パターン表示"
          - "init-guard.sh: 必須ファイル Read 強制"
          - "check-main-branch.sh: main ブランチ禁止"
        subagents: []
        skills: []
        claude_md: "INIT セクション → [自認] 出力"
      output:
        - "[自認] ブロック（what, phase, branch...）"
        - "pending ファイル削除"
      references:
        - ".claude/hooks/session-start.sh"
        - ".claude/hooks/init-guard.sh"
        - ".claude/hooks/check-main-branch.sh"
        - "CLAUDE.md"
        - "state.md"

    - id: work_loop
      name: "LOOP"
      why: |
        playbook の phase を順次実行し、done_criteria を満たすまで反復する。
        critic による検証で報酬詐欺を防止し、確実な品質を保証する。
      when: "INIT 完了後、playbook が存在する場合"
      input:
        - "playbook（current phase, done_criteria）"
        - "subtasks（criterion, executor, test_command）"
      process:
        hooks:
          - "playbook-guard.sh: playbook 存在確認"
          - "scope-guard.sh: スコープ制限"
          - "executor-guard.sh: executor 整合性"
          - "critic-guard.sh: critic 未実行チェック"
        subagents:
          - "critic: PASS/FAIL 判定"
        skills:
          - "test-runner: テスト実行"
        claude_md: "LOOP セクション → subtask 実行"
      output:
        - "ファイル変更（Edit/Write）"
        - "test_command 結果"
        - "critic 判定（PASS/FAIL）"
        - "phase.status = done（PASS の場合）"
      references:
        - ".claude/hooks/playbook-guard.sh"
        - ".claude/hooks/scope-guard.sh"
        - ".claude/hooks/executor-guard.sh"
        - ".claude/hooks/critic-guard.sh"
        - ".claude/agents/critic.md"
        - "CLAUDE.md"

    - id: post_loop
      name: "POST_LOOP"
      why: |
        playbook 完了時に自動でアーカイブ、次 playbook 作成を行う。
        手動操作なしで継続的な進捗を実現する。
      when: "playbook の全 phase が done"
      input:
        - "playbook（全 phase done）"
        - "state.md"
      process:
        hooks:
          - "archive-playbook.sh: アーカイブ提案"
          - "cleanup-hook.sh: tmp/ クリーンアップ"
          - "create-pr-hook.sh: PR 作成トリガー"
        subagents:
          - "pm: 次 playbook 作成"
        skills:
          - "post-loop: 完了処理"
        claude_md: "POST_LOOP セクション → 完了処理"
      output:
        - "playbook アーカイブ（plan/archive/）"
        - "state.md 更新（playbook.active = null）"
        - "次 playbook（存在する場合）"
        - "/clear 推奨アナウンス"
      references:
        - ".claude/hooks/archive-playbook.sh"
        - ".claude/hooks/cleanup-hook.sh"
        - ".claude/hooks/create-pr-hook.sh"
        - ".claude/agents/pm.md"
        - ".claude/skills/post-loop/"
        - "CLAUDE.md"

    - id: critique_process
      name: "CRITIQUE"
      why: |
        「完了」の自己判断を禁止し、critic SubAgent による客観的検証で報酬詐欺を防止。
        done_criteria の達成を証拠付きで確認。
      when: "phase 完了申告時"
      input:
        - "phase.done_criteria"
        - "test_command 実行結果"
        - "変更内容"
      process:
        hooks:
          - "critic-guard.sh: critic 実行チェック"
        subagents:
          - "critic: done_criteria 検証"
        skills: []
        claude_md: "CRITIQUE セクション参照"
      output:
        - "critic 判定（PASS/FAIL）"
        - "根拠（evidence）"
        - "修正指示（FAIL の場合）"
      references:
        - ".claude/hooks/critic-guard.sh"
        - ".claude/agents/critic.md"
        - ".claude/frameworks/done-criteria-validation.md"
        - "CLAUDE.md"

    - id: merge_flow
      name: "MERGE"
      why: |
        playbook 完了後、feature ブランチを main にマージし、GitHub にプッシュ。
        state.md を neutral 状態にリセットして次の作業に備える。
      when: "playbook 完了後、ユーザーがマージを要求"
      input:
        - "現在の feature ブランチ"
        - "state.md"
      process:
        hooks:
          - "merge-pr.sh: main マージ"
        subagents: []
        skills:
          - "post-loop: 完了処理"
        claude_md: "POST_LOOP セクション"
      output:
        - "main ブランチにマージ"
        - "GitHub にプッシュ"
        - "state.md neutral 状態"
        - "/clear 推奨"
      references:
        - "CLAUDE.md"
        - ".claude/hooks/merge-pr.sh"

# ==============================================================================
# Design Philosophy
# 拡張システムの設計思想（docs/design-philosophy.md より）
# ==============================================================================

design_philosophy:
  description: "Hook/Skill/SubAgent の設計思想と検証フレームワーク"
  reference: "docs/design-philosophy.md"

  fuse_model:
    name: "導火線モデル（Fuse Model）"
    description: "イベント駆動の処理チェーン"
    flow: "Event → Hook → Skill → SubAgent"
    components:
      hook:
        role: "イベント検知と発火（導火線）"
        trigger: "自動（イベント駆動）"
        control: "ブロック可能（exit 2）"
        config: "settings.json"
      skill:
        role: "専門知識とガイドライン提供"
        trigger: "自動（文脈判断）"
        control: "ブロック不可（ガイダンスのみ）"
        config: ".claude/skills/{name}/SKILL.md"
      subagent:
        role: "複雑タスクの独立実行"
        trigger: "自動/手動（Task ツール）"
        control: "独立実行（別コンテキスト）"
        config: ".claude/agents/{name}.md"

  four_quadrant_validation:
    name: "4QV+ 構成（Four-Quadrant Validation Plus）"
    description: "subtask 検証の 4 象限フレームワーク"
    quadrants:
      Q1_technical:
        name: "Technical（技術的正確性）"
        checks:
          - "コマンド実行結果確認"
          - "ファイル存在確認"
          - "構文エラーチェック"
      Q2_consistency:
        name: "Consistency（整合性）"
        checks:
          - "state.md との整合"
          - "playbook との整合"
          - "設定ファイルとの整合"
      Q3_completeness:
        name: "Completeness（完全性）"
        checks:
          - "全 done_criteria 確認"
          - "関連ファイル更新確認"
          - "抜け漏れチェック"
      Q4_evidence:
        name: "Evidence（証拠ベース検証）"
        checks:
          - "critic SubAgent 検証"
          - "実行結果の記録"
          - "タイムスタンプ付与"
    validation_format:
      technical: "Q1 - 技術的に正しく動作するか"
      consistency: "Q2 - 他コンポーネントと整合性があるか"
      completeness: "Q3 - 必要な変更が全て完了しているか"
      note: "Q4+ は critic SubAgent が証拠ベースで実行"

  integration_patterns:
    - pattern: "Hook → Skill"
      scenario: "セッション開始時の状態確認"
      example: "SessionStart → session-start.sh → state Skill"
    - pattern: "Skill → SubAgent"
      scenario: "playbook 作成の委譲"
      example: "plan-management Skill → pm SubAgent"
    - pattern: "Hook → SubAgent"
      scenario: "Phase 完了時の検証"
      example: "critic-guard.sh → critic SubAgent"
    - pattern: "Circular (LOOP)"
      scenario: "タスク実行ループ"
      example: "playbook-guard → test-runner → critic → subtask-guard → (repeat)"

# ==============================================================================
# 変更履歴
# ==============================================================================
changelog:
  - date: "2025-12-24 01:09:04"
    action: "auto-generated"
    description: "playbook 完了時に自動生成"
