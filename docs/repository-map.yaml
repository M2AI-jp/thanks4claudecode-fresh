# Repository Map
#
# リポジトリ内の全ファイルマッピング（自動生成）
#
# 生成スクリプト: .claude/hooks/generate-repository-map.sh
# 更新タイミング: playbook 完了時
#
# このファイルは自動生成されます。手動編集は上書きされます。

meta:
  generated: "2026-01-01 19:33:30"
  generator: ".claude/hooks/generate-repository-map.sh"
  total_files: 251

hooks:
  directory: .claude/hooks/
  count: 6
  files:
    - name: "generate-repository-map.sh"
    - name: "post-tool.sh"
    - name: "pre-tool.sh"
    - name: "prompt.sh"
    - name: "session.sh"
    - name: "subagent-stop.sh"

agents:
  directory: .claude/skills/*/agents/
  note: "4QV+ アーキテクチャ: SubAgents は各 Skill 内に配置"
  count: 9
  files:
    - name: "executor-resolver"
      skill: "executor-resolver"
      description: "設計意図"
    - name: "codex-delegate"
      skill: "golden-path"
      description: "Codex MCP をラップし、コンテキスト膨張を防止する SubAgent"
    - name: "pm"
      skill: "golden-path"
      description: "重要"
    - name: "prompt-analyzer"
      skill: "prompt-analyzer"
      description: "設計意図"
    - name: "health-checker"
      skill: "quality-assurance"
      description: "description: システム状態の定期監視。state.md/playbook の整合性、git 状態、ファイル存在確認などを行う。"
    - name: "reviewer"
      skill: "quality-assurance"
      description: "正規ソース"
    - name: "critic"
      skill: "reward-guard"
      description: "reviewer との違い"
    - name: "setup-guide"
      skill: "session-manager"
      description: "description: AUTOMATICALLY guides setup process when playbook=setup/playbook-setup.md. Conducts hear"
    - name: "term-translator"
      skill: "term-translator"
      description: "設計意図"

skills:
  directory: .claude/skills/
  invocation: "Claude が文脈から自動検出して Skill ツールで呼び出す"
  usage: "プロンプトにマッチしたら発火。モデル主導で判断。"
  auto_invoke: true
  count: 21
  files:
    - name: "abort-playbook"
      description: "明示的な playbook 中断・破棄処理"
    - name: "access-control"
      description: "アクセス制御"
    - name: "context-management"
      description: "チャット履歴に依存しない状態管理。プロンプト→意図→処理→結果を外部ファイルに記録。"
    - name: "deploy-checker"
      description: "デプロイ準備・検証専門スキル"
    - name: "executor-resolver"
      description: "設計意図"
    - name: "frontend-design"
      description: "プロダクション品質のフロントエンドインターフェースを作成する"
    - name: "git-workflow"
      description: "Git/PR ワークフロー"
    - name: "golden-path"
      description: "Core Contract #1: Golden Path"
    - name: "lint-checker"
      description: "コード品質チェック専門スキル"
    - name: "plan-management"
      description: "description: Multi-layer planning and playbook management. Use when creating playbooks, transitionin"
    - name: "playbook-gate"
      description: "Core Contract #2: Playbook Gate"
    - name: "playbook-init"
      description: "このSkillは pm SubAgent への委譲を強制する。自分で処理してはならない。"
    - name: "post-loop"
      description: "POST_LOOP - playbook 完了後の後処理"
    - name: "prompt-analyzer"
      description: "description: ユーザープロンプトの深層分析を行う専門Skill。5W1H抽出、リスク分析、曖昧さ検出を実施し、pm SubAgentに構造化データを返す。"
    - name: "quality-assurance"
      description: "品質保証"
    - name: "reward-guard"
      description: "Core Contract #3: Reward Fraud Prevention"
    - name: "session-manager"
      description: "セッション管理"
    - name: "state"
      description: "description: このワークスペースの state.md 管理、playbook 運用の専門知識。state.md の更新、done_criteria の判定、CRITIQUE の実行時に使用"
    - name: "term-translator"
      description: "description: ユーザープロンプト内の曖昧な表現をエンジニア用語に変換する専門Skill。prompt-analyzer の ambiguity セクションを受け取り、技術的に明確な表現に変"
    - name: "test-runner"
      description: "テスト実行・検証専門スキル"
    - name: "understanding-check"
      description: "description: タスク依頼時の理解確認システム（5W1H）。playbook 作成前にユーザーの意図を確認し、リスク分析と不明点の洗い出しを行う。pm SubAgent から呼び出される。"

commands:
  directory: .claude/commands/
  count: 6
  invocation: "ユーザーが /command で明示的に呼び出す（例: /test, /lint）"
  usage: "即座に実行される CLI 機能。ユーザーの意図を明確に反映。"
  files:
    - name: "/crit"
      description: "この処理は critic SubAgent に委譲される。直接 CRITIQUE を実行してはならない。"
    - name: "/lint"
      description: "allowed-tools: Read, Bash"
    - name: "/playbook-init"
      description: "正規ソース: `.claude/skills/playbook-init/SKILL.md`"
    - name: "/rollback"
      description: "allowed-tools: Read, Bash"
    - name: "/state-rollback"
      description: "allowed-tools: Read, Write, Bash"
    - name: "/test"
      description: "allowed-tools: Read, Bash"

docs:
  directory: docs/
  count: 7
  files:
    - name: "ai-orchestration.md"
      description: "役割ベース executor 抽象化 - playbook の再利用性向上"
    - name: "ARCHITECTURE.md"
      description: "ユーザー体験ベースの状態遷移マップ"
    - name: "archive-operation-rules.md"
      description: "目的"
    - name: "criterion-validation-rules.md"
      description: "criterion（done_criteria の単位）の検証ルール"
    - name: "folder-management.md"
      description: "全フォルダの役割、テンポラリ/永続区分、削除タイミングを定義"
    - name: "git-operations.md"
      description: "設計方針"

plan:
  directory: plan/
  subdirectories:
    active:
      description: "進行中の playbook"
      count: 0
    archive:
      description: "完了した playbook のアーカイブ（4QV+: 削除済み、git履歴で参照）"
      count: 48
    template:
      description: "playbook テンプレート"
      count: 5

root:
  description: "ルートディレクトリの主要ファイル"
  files:
    - name: "CLAUDE.md"
      description: "```yaml"
    - name: "AGENTS.md"
      description: "このファイルは純粋なコーディングルール。"
    - name: "README.md"
      description: "Claude Code の自律性と品質を向上させるフレームワーク"
    - name: "state.md"
      description: "現在地を示す Single Source of Truth"
    - name: ".gitignore"
      description: ""
    - name: ".mcp.json"
      description: ""

# ==============================================================================
# System Specification (M025)
# Claude の行動ルールの Single Source of Truth
# 注: フロー詳細は workflows セクション参照（M027 MECE 統一）
# ==============================================================================

system_specification:
  description: "Claude の行動ルールの Single Source of Truth"
  note: "init_flow/loop_flow/post_loop_flow は workflows セクションに統一（MECE）"

  behavior_rules:
    description: "CLAUDE.md から抽出した行動ルール"
    core_principles:
      - "pdca_autonomy: playbook 完了 → milestone 更新 → 次 playbook 自動作成"
      - "tdd_first: done_criteria = テスト仕様、根拠必須"
      - "validation: critic は frameworks/ を参照"
      - "plan_based: playbook=null で Edit/Write → ブロック"
      - "git_branch_sync: 1 playbook = 1 branch"
    mandatory_outputs:
      - "[自認]: セッション開始時"
    prohibited_actions:
      - (抽出失敗)

# ==============================================================================
# Hook Trigger Sequence (M027)
# 公式ドキュメント準拠の発火順序
# https://code.claude.com/docs/ja/hooks
# ==============================================================================

hook_trigger_sequence:
  description: "Hook の発火順序（公式ドキュメント準拠）"
  order_reference: "SessionStart → UserPromptSubmit → PreToolUse → PostToolUse → Stop → PreCompact → SessionEnd"
  triggers:
    - trigger: "SessionStart"
      description: "セッション開始時に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "session.sh"
              description: "session.sh - SessionStart/End/PreCompact 導火線"
    - trigger: "UserPromptSubmit"
      description: "ユーザープロンプト送信時に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "prompt.sh"
              description: "prompt.sh - UserPromptSubmit 導火線"
    - trigger: "PreToolUse"
      description: "ツール実行前に発火（matcher でフィルタ可能）"
      matchers:
        - matcher: "*"
          hooks:
            - script: "pre-tool.sh"
              description: "pre-tool.sh - PreToolUse(*) 導火線"
    - trigger: "PostToolUse"
      description: "ツール実行後に発火（matcher でフィルタ可能）"
      matchers:
        - matcher: "*"
          hooks:
            - script: "post-tool.sh"
              description: "post-tool.sh - PostToolUse(*) 導火線"
    - trigger: "PreCompact"
      description: "コンテキスト圧縮前に発火"
      matchers:
        - matcher: "*"
          hooks:
            - script: "compact.sh"
              description: ""

# ==============================================================================
# Workflows (M027)
# 組み合わせモジュール単位でシステム構造を整理
# ==============================================================================

workflows:
  description: "複数コンポーネントが連携して1つの機能を実現する組み合わせモジュール"
  modules:

    - id: init_flow
      name: "INIT"
      why: |
        LLM は状態を保持しないため、毎セッション開始時に現在地を再認識する必要がある。
        state.md/playbook の強制読み込みにより、コンテキストを確実に復元する。
      when: "SessionStart 発火時"
      input:
        - "ユーザーの最初のプロンプト"
        - "state.md（playbook, goal）"
        - "playbook（active な場合）"
      process:
        hooks:
          - "session-start.sh: pending 作成、失敗パターン表示"
          - "init-guard.sh: 必須ファイル Read 強制"
          - "check-main-branch.sh: main ブランチ禁止"
        subagents: []
        skills: []
        claude_md: "INIT セクション → [自認] 出力"
      output:
        - "[自認] ブロック（what, milestone, phase, branch...）"
        - "pending ファイル削除"
      references:
        - ".claude/hooks/session-start.sh"
        - ".claude/hooks/init-guard.sh"
        - ".claude/hooks/check-main-branch.sh"
        - "CLAUDE.md"
        - "state.md"

    - id: work_loop
      name: "LOOP"
      why: |
        playbook の phase を順次実行し、done_criteria を満たすまで反復する。
        critic による検証で報酬詐欺を防止し、確実な品質を保証する。
      when: "INIT 完了後、playbook が存在する場合"
      input:
        - "playbook（current phase, done_criteria）"
        - "subtasks（criterion, executor, test_command）"
      process:
        hooks:
          - "playbook-guard.sh: playbook 存在確認"
          - "scope-guard.sh: スコープ制限"
          - "executor-guard.sh: executor 整合性"
          - "critic-guard.sh: critic 未実行チェック"
        subagents:
          - "critic: PASS/FAIL 判定"
        skills:
          - "test-runner: テスト実行"
        claude_md: "LOOP セクション → subtask 実行"
      output:
        - "ファイル変更（Edit/Write）"
        - "test_command 結果"
        - "critic 判定（PASS/FAIL）"
        - "phase.status = done（PASS の場合）"
      references:
        - ".claude/hooks/playbook-guard.sh"
        - ".claude/hooks/scope-guard.sh"
        - ".claude/hooks/executor-guard.sh"
        - ".claude/hooks/critic-guard.sh"
        - ".claude/agents/critic.md"
        - "CLAUDE.md"

    - id: post_loop
      name: "POST_LOOP"
      why: |
        playbook 完了時に自動でアーカイブ、次 playbook 作成を行う。
        手動操作なしで継続的な進捗を実現する。
      when: "playbook の全 phase が done"
      input:
        - "playbook（全 phase done）"
      process:
        hooks:
          - "archive-playbook.sh: アーカイブ提案"
          - "cleanup-hook.sh: tmp/ クリーンアップ"
          - "create-pr-hook.sh: PR 作成トリガー"
        subagents:
          - "pm: 次 playbook 作成"
        skills:
          - "post-loop: 完了処理"
        claude_md: "POST_LOOP セクション → milestone 更新"
      output:
        - "playbook アーカイブ（plan/archive/）"
        - "state.md 更新（playbook.active = null）"
        - "次 playbook（存在する場合）"
        - "/clear 推奨アナウンス"
      references:
        - ".claude/hooks/archive-playbook.sh"
        - ".claude/hooks/cleanup-hook.sh"
        - ".claude/hooks/create-pr-hook.sh"
        - ".claude/agents/pm.md"
        - ".claude/skills/post-loop/"
        - "CLAUDE.md"

    - id: critique_process
      name: "CRITIQUE"
      why: |
        「完了」の自己判断を禁止し、critic SubAgent による客観的検証で報酬詐欺を防止。
        done_criteria の達成を証拠付きで確認。
      when: "phase 完了申告時"
      input:
        - "phase.done_criteria"
        - "test_command 実行結果"
        - "変更内容"
      process:
        hooks:
          - "critic-guard.sh: critic 実行チェック"
        subagents:
          - "critic: done_criteria 検証"
        skills: []
        claude_md: "CRITIQUE セクション参照"
      output:
        - "critic 判定（PASS/FAIL）"
        - "根拠（evidence）"
        - "修正指示（FAIL の場合）"
      references:
        - ".claude/hooks/critic-guard.sh"
        - ".claude/agents/critic.md"
        - ".claude/frameworks/done-criteria-validation.md"
        - "CLAUDE.md"

    - id: project_complete
      name: "PROJECT_COMPLETE"
      why: |
        playbook 完了時に feature ブランチを main にマージし、GitHub にプッシュ。
        state.md を neutral 状態にリセットして次の作業に備える。
      when: "playbook が完了した場合"
      input:
        - "現在の feature ブランチ"
        - "state.md"
      process:
        hooks:
          - "merge-pr.sh: main マージ"
        subagents:
          - "pm: 完了を検出"
        skills:
          - "post-loop: 完了処理"
        claude_md: "POST_LOOP#PROJECT_COMPLETE"
      output:
        - "main ブランチにマージ"
        - "GitHub にプッシュ"
        - "state.md neutral 状態"
        - "完了アナウンス"
        - "/clear 推奨"
      references:
        - "CLAUDE.md"
        - ".claude/hooks/merge-pr.sh"

# ==============================================================================
# 変更履歴
# ==============================================================================
changelog:
  - date: "2026-01-01 19:33:30"
    action: "auto-generated"
    description: "playbook 完了時に自動生成"
