# File Creation Process Design

> **目的**: phase-*.md のような「単独では参照されないファイル」が生成されるプロセスを改善
>
> **作成日**: 2025-12-09
> **playbook**: playbook-artifact-health.md p4

---

## 1. 現状分析

### 1.1 問題のあった playbook（playbook-current-implementation-redesign）

```yaml
設計:
  - Phase 1-7 で各 phase-X-Y.md を「evidence」として作成
  - Phase 8 で統合し、docs/current-implementation.md を作成

問題:
  - Phase 8 で「統合」は完了したが「中間成果物の削除」は done_criteria に含まれていなかった
  - 統合後のクリーンアップステップがない
  - 結果: 7 件の phase-*.md が plan/active/ に残存
```

### 1.2 pm.md の現在の playbook 作成フロー

```yaml
現在のステップ:
  0. テンプレート参照
  1. ユーザー要望確認
  2. project.md との関連確認
  3. 技術的 done_criteria の検証
  4. ゴールと done_criteria を定義
  5. Phase を分割
  6. playbook 作成
  7. state.md 更新
  8. ブランチ作成

問題:
  - 「中間成果物の処理」に関する記述がない
  - Phase で作成するファイルの lifecycle が定義されていない
```

---

## 2. ファイル作成の分類

### 2.1 ファイルの種類

| 種類 | 説明 | 例 | 処理 |
|------|------|-----|------|
| 最終成果物 | タスク完了後も保持すべきファイル | docs/*.md, .claude/hooks/*.sh | 保持 |
| 中間成果物 | 統合後に不要になるファイル | phase-*.md, draft-*.md | 統合後削除 |
| テンプレート | 再利用されるファイル | plan/template/*.md | 保持 |
| 一時ファイル | 作業中のみ使用 | .tmp/*, *.bak | 即時削除 |

### 2.2 判定フローチャート

```
ファイル作成時の判定:
                    ┌─────────────────┐
                    │ ファイル作成    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ 他のファイルに   │
                    │ 統合されるか？   │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │ YES          │ NO           │
              ▼              ▼              │
    ┌─────────────────┐  ┌─────────────────┐
    │ 中間成果物      │  │ 最終成果物      │
    │ → 統合後削除    │  │ → 保持         │
    └─────────────────┘  └─────────────────┘
```

---

## 3. 改善設計

### 3.1 playbook テンプレートへの追加

playbook-format.md に以下を追加:

```yaml
## 中間成果物の処理（新規セクション）

中間成果物とは:
  - Phase の evidence として作成するファイル
  - 最終的に他のファイルに統合されるもの
  - 例: phase-*.md, draft-*.md, analysis-*.md

ルール:
  - 中間成果物を作成する Phase がある場合、最終 Phase に「クリーンアップ」を含める
  - クリーンアップの done_criteria:
    - 「中間成果物が統合されている」
    - 「中間成果物が削除/アーカイブされている」

推奨パターン:
  - 可能な限り、中間成果物を作成せず既存ファイルに追記する
  - 中間成果物が必要な場合、ファイル名に「draft-」または「temp-」プレフィックスを付ける
```

### 3.2 pm.md への追加

playbook 作成フローに以下を追加:

```yaml
5.5. 中間成果物の確認（新規ステップ）
   → Phase で作成するファイルをリストアップ
   → 中間成果物がある場合、最終 Phase に「クリーンアップ」を追加
   → クリーンアップの done_criteria を明記
```

### 3.3 中間成果物検出 Hook（オプション）

```bash
# check-intermediate-files.sh（設計のみ）
# 発火条件: PostToolUse:Write
# 目的: 中間成果物らしきファイル作成を検出して警告

# 検出パターン:
# - phase-*.md
# - draft-*.md
# - temp-*.md
# - analysis-*.md

# 動作:
# - 警告を出力（ブロックはしない）
# - 「このファイルは中間成果物ですか？最終 Phase でクリーンアップを忘れずに」
```

---

## 4. 過去の phase-*.md の処理

### 4.1 判定結果（p2 より）

| ファイル | 判定 | 理由 |
|---------|------|------|
| phase-1-mapping.md | 削除 | current-implementation.md に統合済み |
| phase-2-inventory.md | 削除 | 同上 |
| phase-3-flow.md | 削除 | 同上 |
| phase-4-justification.md | 削除 | 同上 |
| phase-5-dependencies.md | 削除 | 同上 |
| phase-6-recovery.md | 削除 | 同上 |
| phase-7-cleanup-list.md | 削除 | 同上 |

### 4.2 削除コマンド

```bash
# p6 で実行予定
rm plan/active/phase-*.md
git add -A && git commit -m "chore: remove intermediate files (phase-*.md)"
```

---

## 5. 改善後のプロセスフロー図

```
┌─────────────────────────────────────────────────────────────┐
│                    playbook 作成フロー（改善後）             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. テンプレート参照                                        │
│     ↓                                                        │
│  2. ユーザー要望確認                                        │
│     ↓                                                        │
│  3. Phase 設計                                               │
│     ↓                                                        │
│  4. 【新規】中間成果物の確認                                │
│     │                                                        │
│     ├─→ 中間成果物あり → 最終 Phase に「クリーンアップ」追加│
│     │                                                        │
│     └─→ 中間成果物なし → そのまま進む                       │
│     ↓                                                        │
│  5. playbook 作成                                            │
│     ↓                                                        │
│  6. LOOP 開始                                                │
│     ↓                                                        │
│  7. Phase 実行（中間成果物作成の場合あり）                   │
│     ↓                                                        │
│  8. 【新規】最終 Phase でクリーンアップ実行                  │
│     ↓                                                        │
│  9. POST_LOOP（アーカイブ含む）                              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 実装計画

### Phase 1: playbook-format.md の更新

```yaml
変更内容:
  - 「中間成果物の処理」セクションを追加
  - 判定フローチャートを追加
  - 推奨パターンを明記

必要な許可: なし（通常ファイル）
```

### Phase 2: pm.md の更新

```yaml
変更内容:
  - playbook 作成フローにステップ 5.5 を追加
  - 中間成果物の確認手順を明記

必要な許可: なし（通常ファイル）
```

### Phase 3: Hook 作成（オプション）

```yaml
ファイル: .claude/hooks/check-intermediate-files.sh
動作: 警告のみ（ブロックしない）
登録: settings.json PostToolUse:Write

必要な許可: なし
```

---

## 変更履歴

| 日時 | 内容 |
|------|------|
| 2025-12-09 | 初版作成。p4 ファイル作成プロセス設計完了。 |
