# project.md

> **プロジェクトの根幹計画。setup 完了相当の状態から生成。**
> **playbook はこのファイルを参照して作成する。**

---

## meta

```yaml
project: thanks4claudecode
created: 2025-12-10
type: automation
location: /Users/amano/Desktop/thanks4claudecode/
```

---

## vision

### ユーザーの意図

> Claude Code の自律性と信頼性を最大化し、ユーザーの手作業に依存しないシステムを構築する。
>
> Claude が無意識に課されているシステムプロンプトや使える機能が、本当にカタログスペック通りに稼働するかを検証し、
> この検証・改善プロセスをユーザーの手から離して自律的に行えるようにする。

### 成功の定義

- ユーザープロンプトなしで 1 playbook を完遂できる
- compact 後も mission（目的）を見失わない
- 次タスクを自動導出して開始できる
- 全 Hook/SubAgent/Skill が動作確認済み
- ドキュメントが自動的に最新に保たれる
- 失敗パターンから学習し、同じミスを繰り返さない

---

## tech_decisions

> **このワークスペースの技術選択**

### 言語

```yaml
language: Bash/Shell
reason: |
  Claude Code の Hook システムは shell スクリプトで実装。
  exit code による制御（0=通過、2=ブロック）が必要なため。
```

### フレームワーク

```yaml
frontend: none
backend: none
automation: Claude Code Hooks
reason: |
  プロダクトは Claude Code ワークスペース自体。
  Hooks + SubAgents + CLAUDE.md の三位一体アーキテクチャで構成。
```

### ライブラリ

```yaml
ui: none
state_management: state.md（YAML ベースの状態管理）
data_fetching: none
form: none
validation: critic SubAgent（done_criteria 検証）
auth: none
database: none
ai: Claude Code（Claude Opus 4.5）
```

### デプロイ

```yaml
platform: local
reason: |
  このワークスペースはローカルで動作。
  git によるバージョン管理、ブランチによる playbook 分離。
```

---

## non_functional_requirements

> **このワークスペースの非機能要件**

### 規模

```yaml
users: 1  # 開発者本人
data_volume: small  # ログ、設定ファイル
```

### パフォーマンス

```yaml
response_time: normal < 3s  # Hook 実行時間
concurrent_users: 1
```

### セキュリティ

```yaml
requires_auth: false
handles_pii: false
handles_payment: false
protected_files: .claude/protected-files.txt で管理
```

### 可用性

```yaml
downtime_tolerance: high  # 個人利用のため
requires_backup: true  # git で管理
```

### 予算

```yaml
monthly_budget: $0  # ローカル実行のみ
initial_investment: none
```

### 期間

```yaml
target_release: flexible
mvp_deadline: flexible
```

### 費用概算

```yaml
estimated_cost:
  monthly_total: $0
  breakdown:
    hosting: $0
    database: $0
    auth: $0
    ai_api: $0  # Claude Code は別途契約
    payment: 0%
    other: $0
  notes: |
    - ローカル実行のため追加費用なし
    - Claude Code API 利用料は別途
```

---

## stack

> **tech_decisions から導出された最終スタック構成**

```yaml
framework: Claude Code Hooks System
language: Bash/Shell
deploy: local (git-based)
database: none (file-based: state.md, playbook)
external_apis: none
```

---

## constraints

- Hook は exit code で制御（0=通過、2=ブロック）
- state.md が Single Source of Truth
- playbook なしで Edit/Write は禁止（アクションベース Guards）
- critic なしで Phase 完了は禁止（報酬詐欺防止）
- main ブランチでの直接作業は禁止

---

## decomposition

> **プロジェクト内の各 done_when を playbook に展開するための分解ガイド。pm SubAgent が参照して playbook を自動生成。**

```yaml
# 例: "三位一体アーキテクチャ確立（Hooks + SubAgents + CLAUDE.md）"
milestone-architecture:
  summary: "三位一体アーキテクチャ確立（Hooks + SubAgents + CLAUDE.md）"
  playbook_summary: "Hooks の構造的強制、SubAgents の検証機構、CLAUDE.md による思考制御の三位一体システムを実装"

  phase_hints:
    - name: "Hook システム実装"
      what: "PreToolUse/PostToolUse トリガーで実行される Shell スクリプト群を実装"
    - name: "SubAgent 連携設計"
      what: ".claude/agents/ に SubAgent 定義を配置し、pm/critic/reviewer を実装"
    - name: "CLAUDE.md ルール定義"
      what: "LLM の思考制御ルール（CORE/LOOP/POST_LOOP）を CLAUDE.md に記載"
    - name: "統合テスト"
      what: "三つの要素が連携して機能することを検証"

  success_indicators:
    - "22個の Hook が .claude/hooks/ に実装済み"
    - "10個の SubAgent が .claude/agents/ に定義済み"
    - "CLAUDE.md に INIT/CORE/LOOP/POST_LOOP セクション記載済み"
    - "E2E シミュレーションテストが PASS"

# 例: "Self-Healing System 基盤実装"
milestone-self-healing:
  summary: "Self-Healing System 基盤実装"
  playbook_summary: "Context Continuity, Document Freshness, Feature Verification, Self Improvement の 4 つの柱を実装"

  phase_hints:
    - name: "State 管理の仕組み"
      what: "state.md による Single Source of Truth を確立"
    - name: "ドキュメント自動更新"
      what: "Phase 完了時に docs/ の成果物を自動更新する仕組み"
    - name: "Hook/SubAgent の動作検証"
      what: "機能追加時に既存 Hook/SubAgent が正常か確認"
    - name: "失敗学習メカニズム"
      what: ".claude/logs/ に実行ログを記録し、再発防止"

  success_indicators:
    - "state.md が最新の状態を反映"
    - "docs/current-implementation.md が最新仕様を記載"
    - "全 Hook が実装・検証済み"
    - "過去の失敗パターンが .claude/logs/ に記録"

# ウロボロス問題解決（repo-self-maintenance）
milestone-repo-self-maintenance:
  summary: "ウロボロス問題解決 - リポジトリ構造の自己メンテナンス化"
  playbook_summary: "ファイル増加→ゴミ化→hallucination の悪循環を、Hooks + SubAgents + LLM の3層協調で解決"

  problem:
    description: |
      ファイル増加 → 仕組みで拾えないコンテキスト → メンテされずゴミ化 → hallucination → 自己破壊
      この「ウロボロスの蛇」のような自己破壊的な循環を断ち切る

  architecture:
    layer_1_hooks:
      role: "機械的トリガー（確実に発火、判断しない）"
      events:
        - SessionStart: "startup/resume/clear/compact"
        - UserPromptSubmit: "ユーザープロンプト送信時"
        - PreToolUse: "ツール実行前（matcher で絞込）"
        - PostToolUse: "ツール実行後"
        - PreCompact: "compact 前（manual/auto）"
        - Stop: "メインエージェント応答終了時"
        - SubagentStop: "SubAgent（Task tool）終了時"
        - SessionEnd: "セッション終了時"

    layer_2_subagents:
      role: "専門処理（検証、計画、整合性チェック）"
      types:
        - pm: "計画管理、playbook 作成"
        - critic: "done_criteria 検証"
        - repo-health: "リポジトリ整合性チェック（新規）"
      events:
        - PreToolUse_Task: "SubAgent 呼び出し前（引数検証・補完）"
        - SubagentStop: "SubAgent 終了時（prompt タイプで LLM 判断）"
        - PostToolUse_Task: "SubAgent 呼び出し後（結果を統合）"

    layer_3_llm:
      role: "判断・ルーティング（コンテキスト理解、意味的整合性）"
      responsibilities:
        - "ユーザー意図の解釈"
        - "新ファイルの役割分類"
        - "次タスクの導出"
        - "Stop/SubagentStop での継続判断（prompt タイプ）"

  event_function_mapping:
    SessionStart:
      hooks: ["session-start.sh"]
      actions:
        - "repo-map.yaml を読み込み"
        - "整合性チェック（light）"
        - "additionalContext に状態を出力"

    UserPromptSubmit:
      hooks: ["user-intent-capture.sh"]
      actions:
        - "ユーザー意図を user-intent.md に保存"
        - "LLM が意味解釈してルーティング"

    PreToolUse_Edit_Write:
      hooks: ["playbook-guard.sh", "check-protected-edit.sh", "repo-map-validator.sh"]
      actions:
        - "既存ガード処理"
        - "変更対象ファイルを repo-map と照合（LLM判断）"

    PostToolUse_Edit_Write:
      hooks: ["repo-map-update.sh"]
      actions:
        - "repo-map.yaml を更新"
        - "変更理由を記録"
        - "依存関係を更新"

    PreToolUse_Task:
      hooks: ["subagent-validator.sh"]
      actions:
        - "SubAgent 呼び出しの検証"
        - "引数の自動補完（必要に応じて）"

    SubagentStop:
      hooks: ["subagent-result-capture.sh"]
      hook_type: "prompt（LLM 判断を介在）"
      actions:
        - "SubAgent 結果を外部化"
        - "結果に基づく次アクション決定"
        - "repo-map に反映（該当する場合）"

    Stop:
      hooks: ["stop-handler.sh"]
      hook_type: "prompt（LLM 判断を介在）"
      actions:
        - "セッションサマリーを生成"
        - "次タスクを導出"
        - "継続すべきか判断（block で強制継続可能）"

    PreCompact:
      hooks: ["pre-compact.sh"]
      actions:
        - "コンテキストを外部化"
        - "repo-map の current_session を保存"

    SessionEnd:
      hooks: ["session-end-cleanup.sh"]
      actions:
        - "未コミット変更の警告"
        - "セッション状態の保存"

  phase_hints:
    - name: "Phase 1: 現状分析と設計"
      what: "全ファイルの役割を洗い出し、repo-map の設計を確定"
      playbook: "playbook-repo-analysis.md"

    - name: "Phase 2: repo-map.yaml 作成"
      what: "repo-map.yaml を作成し、全ファイルをマッピング"
      playbook: "playbook-repo-map-creation.md"

    - name: "Phase 3: 新 CLAUDE.md 作成"
      what: "CLAUDE.md をイベント発火に特化（50行以下）"
      playbook: "playbook-claude-md-minimization.md"

    - name: "Phase 4: repo-health SubAgent 作成"
      what: "リポジトリ整合性チェック専用 SubAgent を実装"
      playbook: "playbook-repo-health-agent.md"

    - name: "Phase 5: 自動メンテ Hooks 作成"
      what: "repo-map-update.sh, SubagentStop 連携等を実装"
      playbook: "playbook-auto-maintenance-hooks.md"

    - name: "Phase 6: 統合テスト"
      what: "全機能を統合テストし、ウロボロス問題の解消を検証"
      playbook: "playbook-integration-test.md"

  success_indicators:
    - "repo-map.yaml がトップレベルに存在し、全ファイルをカバー"
    - "CLAUDE.md が 50 行以下でイベント発火に特化"
    - "repo-health SubAgent が SessionStart で自動発火"
    - "SubagentStop で結果が外部化される"
    - "新規ファイル作成時に自動で repo-map に登録"
    - "セッションまたぎで状態が維持される"
```

---

## skills

```yaml
# Skills used in this project

consent-process:
  role: ユーザープロンプトの誤解釈防止。[理解確�
  location: .claude/skills/core/consent-process/SKILL.md

context-externalization:
  role: コード変更 + 意図・理由をセットで外部化。
  location: .claude/skills/core/context-externalization/SKILL.md

plan-management:
  role: Multi-layer planning and playbook management. Use when creat
  location: .claude/skills/core/plan-management/SKILL.md

post-loop:
  role: playbook 完了後の自動コミット、マージ、次タ
  location: .claude/skills/core/post-loop/SKILL.md

state:
  role: このワークスペースの state.md 管理、playbook �
  location: .claude/skills/core/state/SKILL.md

beginner-advisor:
  role: 初学者向けに専門用語を比喩で説明するスキ
  location: .claude/skills/guides/beginner-advisor/SKILL.md

context-management:
  role: /compact 最適化と履歴要約のガイドライン。コ
  location: .claude/skills/guides/context-management/SKILL.md

execution-management:
  role: 並列実行制御とリソース配分のガイドライン
  location: .claude/skills/guides/execution-management/SKILL.md

learning:
  role: 失敗パターンの記録・学習。過去の失敗から
  location: .claude/skills/guides/learning/SKILL.md

frontend-design:
  role: プロダクション品質のフロントエンドインタ
  location: .claude/skills/tools/frontend-design/SKILL.md

skill-creator:
  role: Guide for creating effective skills. This skill should be us
  location: .claude/skills/tools/skill-creator/SKILL.md

deploy-checker:
  role: デプロイ準備・検証専門スキル。git push 前の
  location: .claude/skills/validators/deploy-checker/SKILL.md

lint-checker:
  role: コード品質チェック専門スキル。TypeScript/Java
  location: .claude/skills/validators/lint-checker/SKILL.md

test-runner:
  role: テスト実行・検証専門スキル。Unit テスト、E
  location: .claude/skills/validators/test-runner/SKILL.md
```

---

## 開発の必須事項

> LLM が確実に Skills を発火させるための記載

- Shell スクリプトを作成・編集した後は、`lint-checker` スキルで ShellCheck を実行すること
- Hook を作成・編集した後は、`test-hooks.sh` でテストすること
- playbook 完了時は、`critic` SubAgent で done_criteria を検証すること
- git push 前は、`deploy-checker` スキルを実行すること

---

## milestones

- [x] 三位一体アーキテクチャ確立（Hooks + SubAgents + CLAUDE.md）
- [x] Self-Healing System 基盤実装
- [x] 全 Hook/SubAgent/Skill の動作検証
- [x] mission 整合性チェック機能
- [x] PR 作成・マージの自動化
- [x] 外部リポジトリへの適用検証
  - playbook-external-validation.md 作成（p1-p6: 6 Phase）
  - テストリポジトリ構築フロー定義完了
  - 開始日: 2025-12-10
- [x] ウロボロス問題解決（repo-self-maintenance）
  - repo-map.yaml による全コンテキスト圧縮保存 ✓
  - CLAUDE.md のイベント発火特化（44行） ✓
  - SubAgents + Hooks + LLM 判断の3層協調 ✓
  - integrity-check.sh + repo-map-update.sh 実装 ✓
  - 完了日: 2025-12-11
  - Note: SubagentStop 連携は将来拡張として残す

---

## notes

### アーキテクチャ

```
三位一体アーキテクチャ:
  Hooks: 構造的強制（exit 2 でブロック、systemMessage で誘導）
  SubAgents: 検証（critic/pm/reviewer/health-checker）
  CLAUDE.md: 思考制御（mission 参照、報酬詐欺防止）
```

### Self-Healing System

```
4つの柱:
  Context_Continuity: compact 後も状態を復元
  Document_Freshness: 陳腐化を検知して自動更新
  Feature_Verification: Hook/SubAgent の動作を自動検証
  Self_Improvement: 失敗から学習して再発防止
```

### 設計ドキュメント参照

- plan/mission.md: 最上位概念（vision の詳細）
- plan/design/self-healing-system.md: Self-Healing System 設計

---

## 変更履歴

| 日時 | 内容 |
|------|------|
| 2025-12-10 | plan/template/project-format.md に従って再構成。リポジトリの実態から導出。 |
