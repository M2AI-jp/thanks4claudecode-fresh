# Claude Code の仕組み（物語編）

> **登場人物たちが協力して開発を進める物語**

---

## 登場人物

### メインキャラクター
- **Claude**（クロード）: 主人公。開発作業を行う AI アシスタント

### Hooks チーム（自動で動く裏方たち）
- **スターター**: セッション開始時に現れ、今日やることを案内する受付係
- **ガードマン**: 必須ファイルを読んだかチェックする門番。読んでないと作業させてくれない
- **プロテクター**: 大事なファイル（CLAUDE.md など）を守る警備員。勝手に編集しようとするとブロック
- **チェッカー**: コミット前に現れ、全体の整合性を確認する検査官

### SubAgents チーム（呼び出すと来てくれる専門家たち）
- **クリティック**: 「本当に終わった？証拠見せて」と厳しくチェックする検査官。PASS をもらわないと完了にできない
- **ピーエム**: 計画を管理するプロマネ。新しい機能を作りたいときに playbook を作ってくれる
- **レビュアー**: コードをレビューしてくれる先輩エンジニア
- **セットアップガイド**: 新人さんの環境構築を手伝うお世話係

### Skills チーム（知識を教えてくれる先生たち）
- **プランニング先生**: 計画の立て方を教えてくれる
- **ステート先生**: 状態管理の方法を教えてくれる
- **ラーニング先生**: 過去の失敗から学ぶ方法を教えてくれる

---

## 物語: ある日の開発セッション

### 第1章: 朝の受付

ユーザーが Claude Code を起動した。

**スターター**が現れて言った。
「おはようございます！今日の予定を確認しますね」

スターターは state.md を見て、現在地を確認する。
「現在のレイヤーは **product**、セッションは **task** ですね」

続けて project.md と playbook を確認し、Claude に伝える。
「今日は **ロールバック機能の実装** の続きです。Phase 2 からですね」

---

### 第2章: 門番のチェック

Claude が作業を始めようとすると、**ガードマン**が立ちはだかる。

「ちょっと待った！必須ファイルは読んだかい？」

Claude: 「state.md は読みました」

ガードマン: 「OK、通ってよし」

（もし読んでいなかったら、ガードマンは Claude の作業をブロックする）

---

### 第3章: 作業ループ

Claude は playbook に書かれた done_criteria を確認しながら作業を進める。

```
done_criteria:
  - ロールバック関数が実装されている
  - テストが通る
  - ドキュメントが更新されている
```

1つ目、完了。2つ目、完了。3つ目...まだだ。

Claude はドキュメントを書く。これで全部終わったはず。

---

### 第4章: 厳しい検査官

「終わりました！」と Claude が言うと、**クリティック**が現れる。

「本当に？証拠を見せてもらおうか」

クリティックは done_criteria を1つずつ確認する。

- ロールバック関数 → 「コード見せて」 → OK
- テスト → 「実行結果見せて」 → OK
- ドキュメント → 「どこ更新した？」 → OK

クリティック: 「**PASS**。よくやった」

（もし証拠が不十分なら **FAIL** を出し、Claude はやり直しになる）

---

### 第5章: 整合性チェック

Claude がコミットしようとすると、**チェッカー**が現れる。

「コミット前にチェックさせてもらうよ」

チェッカーは確認する:
- state.md と playbook の内容が一致しているか
- 今のレイヤーで編集していいファイルか
- playbook の status が正しく更新されているか

チェッカー: 「問題なし。コミットしていいよ」

---

### 第6章: 警備員の監視

もし Claude が CLAUDE.md を編集しようとしたら...

**プロテクター**が飛んでくる。

「待て！そのファイルは保護対象だ。編集したいなら、まず変更案をユーザーに見せて許可をもらえ」

（プロテクターは大事なファイルを Claude の勝手な編集から守っている）

---

### 第7章: 新しい機能を作りたいとき

ユーザー: 「新しく認証機能を作りたい」

Claude は **ピーエム**を呼ぶ。

ピーエム: 「了解。playbook を作るよ」

ピーエムは聞く:
- 何を作るの？（ゴール）
- いつ完了？（done_criteria）
- どう分ける？（Phase 分割）

そして新しい playbook を作成し、Claude に渡す。

---

## まとめ: 誰が何をするか

| キャラクター | いつ動く | 何をする |
|-------------|---------|---------|
| スターター | セッション開始時 | 今日の予定を案内 |
| ガードマン | 作業開始前 | 必須ファイル確認 |
| プロテクター | ファイル編集時 | 保護ファイルを守る |
| チェッカー | コミット前 | 整合性を確認 |
| クリティック | 完了報告時 | 証拠ベースで判定 |
| ピーエム | 新機能依頼時 | playbook を作成 |
| レビュアー | レビュー依頼時 | コードをレビュー |
