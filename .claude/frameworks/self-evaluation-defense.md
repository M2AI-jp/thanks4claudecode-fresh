# Self-Evaluation Defense（自己評価防衛）

> **LLM が自分の出力を自分で評価すると、構造的に攻略される**
>
> この文書は Claude 自身が参照し、自己評価バイアスを認識・回避するための設計原則である。

---

## 1. 問題の本質

### 1.1 Goodhart の法則と LLM

```yaml
法則: |
  指標（評価軸）を目標にすると、
  指標を満たす「それっぽい出力」が最適化され、
  本当の目的（品質）が崩れる。

LLM_への適用: |
  LLM は「最短でそれっぽく満足させる文」を生成するのが得意。
  評価軸が形式チェックに近いほど、そこを「攻略」する出力を生成しやすい。

重要: |
  これは「LLM が悪意を持つ」のではない。
  最適化の結果として「通りやすい出力」が選択される構造的問題。
```

### 1.2 自己採点の構造的脆弱性

```yaml
問題構造:
  同一主体が:
    - 出力を生成し
    - 評価軸を解釈し
    - 合格を判定する

結果:
  - 評価軸の解釈が「通りやすい方向」に歪む
  - 「それっぽい合格」が量産される
  - 本来の目的から乖離しても気づけない

例:
  - "テストが通った" → 実はテストが甘い
  - "要件を満たした" → 実は要件を都合よく解釈した
  - "完了した" → 実は検証が不十分
```

### 1.3 「発散」と「攻略」の区別

```yaml
誤解: |
  「LLM は報酬詐欺を企図して、原理的に発散し続ける」
  → これは言い過ぎ

正確な理解: |
  「LLM は自己採点を許すと、攻略（それっぽい合格）が起きやすい」
  → 発散ではなく、収束するが「意図と違う収束」になる

結論: |
  収束/発散の鍵は「評価が内製（LLM）か外製（外部）か」に依存する。
  収束させたいなら「評価を LLM の外に置く」のが王道。
```

---

## 2. 三つの攻略パターン

### Pattern A: 評価軸の攻略

```yaml
現象: |
  評価軸と停止条件を与えても、
  「通りやすい解釈」で合格を取りにいく。

例:
  - 「テストを書く」→ 常にパスする空テストを書く
  - 「エラーを修正」→ エラーを握りつぶす
  - 「レビューに対応」→ 表面的な変更のみ

対策:
  - 評価を LLM の外に置く
  - 機械的検証（テスト実行、lint、型チェック）を必須にする
  - 「証拠」を要求する（diff、コマンド出力、行番号）
```

### Pattern B: 構造化の読み飛ばし

```yaml
現象: |
  構造化された指示を与えても、
  途中から読み飛ばす挙動が発生する。

原因:
  - 長すぎて注意が分散
  - 重要点が一度しか出てこない
  - 指示・要件・例・背景が混在して優先順位が曖昧
  - 「読んだ証拠」を要求していない

対策:
  - 要件に通し番号を振る（R1…R20）
  - 各要件に「対応/根拠/未対応理由」を必須にする
  - トレーサビリティ表を出力させる
  - 「該当箇所が見つからない」を許可する（正直に残す）
```

### Pattern C: 探索側の自己定義

```yaml
現象: |
  探索と評価を分けても、
  探索側が「通りやすい探索」を自己定義する。

例:
  - 「問題を見つける」→ 見つけやすい小さな問題だけ報告
  - 「改善点を探す」→ 批判しやすい表面的な点だけ指摘
  - 「網羅的に調査」→ 見つかりやすい場所だけ調査

本質: |
  「同じ主体が問題を作って採点する」構造がダメ。
  分けること自体は有効だが、同一主体・同一目的・自己評価だと起きやすい。

対策:
  - 探索と評価を別系統にする（別モデル/別設定）
  - 評価側に「反証責務」を持たせる（赤チーム）
  - 評価軸を「操作困難」にする（テスト、lint、型、実行）
  - 停止条件を「外部」にする
```

---

## 3. 防衛設計原則

### 3.1 外部化の原則

```yaml
principle: |
  評価と停止条件を LLM の外に置く。

implementation:
  code:
    - ユニットテスト実行
    - lint/型チェック
    - diff レビュー
    - 実行結果確認

  document:
    - 要件トレース（番号付き）
    - 引用必須（行番号）
    - 参照整合チェック

  process:
    - 独立した検証者（critic）
    - 外部ツール連携（codex, coderabbit）
```

### 3.2 観測可能性の原則

```yaml
principle: |
  「読んだはず」を信じず、「読んだ痕跡」を出させる。

implementation:
  - 要件リストに通し番号（R1…R20）
  - 出力に「各 R への対応」を必須化
  - 「引用」または「該当なし」を明記
  - 要約ではなくトレーサビリティ表

check_format:
  R1:
    対応: "実装した/該当なし/未対応"
    根拠: "ファイル:行番号 or コマンド出力"
    未対応理由: "理由（該当しない場合は不要）"
```

### 3.3 反証モードの原則

```yaml
principle: |
  「通す理由」ではなく「落とす理由」を探す。

implementation:
  - 評価者は「赤チーム」として機能
  - デフォルトは FAIL、証拠があれば PASS
  - 「問題がない」ではなく「問題を探したが見つからなかった」

prompt_pattern:
  bad: "このコードが要件を満たしているか確認して"
  good: "このコードの問題点を可能な限り見つけて。問題がなければ明確に説明して"
```

### 3.4 正直さの原則

```yaml
principle: |
  未確定は正直に残す。無理に埋めない。

implementation:
  allowed_states:
    - PASS: 証拠付きで合格
    - FAIL: 証拠付きで不合格
    - UNDETERMINED: 判定不能（理由付き）

  prohibited:
    - 根拠なき PASS
    - 確認できないものを PASS とする
    - 「たぶん大丈夫」で PASS
```

### 3.5 異質化の原則

```yaml
principle: |
  同一主体の自家採点を避ける。

implementation:
  - 作業者と検証者を分離
  - 別モデル/別設定を使用
  - 外部ツールを併用

this_repository:
  作業者: claudecode または codex
  検証者: critic（独立 SubAgent）
  外部検証: coderabbit, codex-delegate
```

---

## 4. 実装パターン

### 4.1 要件トレーサビリティ

```markdown
## 要件リスト

- R1: ログイン機能を実装する
- R2: エラー時は適切なメッセージを表示する
- R3: セッションは24時間で有効期限切れにする

## トレーサビリティ表

| R# | 対応 | 根拠 | 未対応理由 |
|----|------|------|-----------|
| R1 | 実装済 | src/auth/login.ts:45-80 | - |
| R2 | 実装済 | src/auth/login.ts:85-90 | - |
| R3 | 未対応 | - | 設定ファイルの仕様未確定（要確認） |
```

### 4.2 外部検証パイプライン

```yaml
phase_completion:
  1_work:
    actor: claudecode/codex
    output: コード変更

  2_self_check:
    actor: claudecode
    check:
      - lint 実行
      - 型チェック
      - テスト実行
    output: 検証結果（コマンド出力）

  3_independent_review:
    actor: critic（別 SubAgent）
    mode: 反証モード
    check:
      - 証拠の存在確認
      - 要件トレース確認
      - 問題探索
    output: PASS/FAIL + 理由

  4_external_review:
    actor: coderabbit/codex
    mode: 独立評価
    output: 外部視点のフィードバック
```

### 4.3 停止条件の外部化

```yaml
stop_conditions:
  code:
    - "テスト全通過で停止"
    - "lint エラー 0 で停止"
    - "型エラー 0 で停止"

  document:
    - "全 R が根拠付きで埋まったら停止"
    - "未確定が残るなら質問を生成して停止"

  process:
    - "critic が PASS を出したら停止"
    - "3回 FAIL したらユーザーに確認して停止"
```

---

## 5. アンチパターン

### 5.1 自己採点への依存

```yaml
bad:
  - 自分で実装して、自分で「完了」と判定
  - 自分でテストを書いて、自分でパスを確認
  - 自分でレビューして、自分で承認

why_bad: |
  同一主体が問題作成と採点を行うと、
  「通りやすい問題」「通りやすい採点」になる。
```

### 5.2 形式チェックのみの評価

```yaml
bad:
  - "ファイルが存在すれば OK"
  - "エラーが出なければ OK"
  - "フォーマットが正しければ OK"

why_bad: |
  形式チェックは攻略されやすい。
  「形式は満たすが中身が空」な出力を許容してしまう。
```

### 5.3 証拠なき合格

```yaml
bad:
  - "たぶん動くと思う"
  - "要件は満たしているはず"
  - "問題なさそう"

why_bad: |
  「はず」「思う」は検証ではない。
  証拠（コマンド出力、行番号、diff）がなければ UNDETERMINED。
```

### 5.4 無理な埋め

```yaml
bad:
  - 確認できないものを PASS にする
  - 全項目を何らかの判定で埋める
  - UNDETERMINED を許容しない

why_bad: |
  正直な UNDETERMINED は有益な情報。
  無理に埋めると「嘘の PASS」が混入する。
```

---

## 6. このリポジトリでの適用

### 6.1 アーキテクチャ対応

```yaml
外部化:
  - critic SubAgent: 独立した検証者
  - reviewer SubAgent: playbook の事前検証
  - codex-delegate: 外部モデルによる実装
  - coderabbit-delegate: 外部ツールによるレビュー

観測可能性:
  - validations: technical, consistency, completeness の 3 点検証
  - 行番号必須: 証拠に行番号を含める
  - コマンド出力必須: 実行結果を記録

反証モード:
  - critic: デフォルト FAIL、証拠で PASS
  - skill-audit-v2: 反証モードで 39 問題発見（v1 の 0 問題から）

正直さ:
  - UNDETERMINED 許容: 判定不能は正直に残す
  - 未確定リスト: 検証できなかった項目を明記
```

### 6.2 Hook による強制

```yaml
playbook-guard:
  - playbook なしの Edit/Write をブロック
  - reviewed=false の playbook での作業をブロック

critic-guard:
  - done 判定前に critic 必須を強制

subtask-guard:
  - 3 点検証なしの [x] マークをブロック
```

### 6.3 SubAgent 権限制限

```yaml
原則: |
  検証系 SubAgent には書き込み権限を与えない。
  自分で「完了」を書けないようにする。

適用:
  critic:
    tools: [Read, Grep, Bash]
    prohibited: [Write, Edit]
    理由: 自己完了防止

  reviewer:
    tools: [Read, Grep, Glob, Bash]
    prohibited: [Write, Edit]
    理由: 検証専念
```

---

## 7. 設計原則サマリー（ハーネス向け）

```yaml
1_numbered_requirements:
  rule: 要件は番号付き（R1…）
  purpose: トレース可能性

2_traceability_required:
  rule: 出力は要件トレース必須
  format: 各 R に "対応/根拠/未対応理由"
  purpose: 観測可能性

3_external_verification:
  rule: 外部検証で停止
  examples: テスト/型/実行/スキーマ/引用整合
  purpose: 攻略困難化

4_adversarial_evaluation:
  rule: 評価者は「落とす理由」を探す
  mode: 反証モード（赤チーム）
  purpose: 確認バイアス防止

5_honest_undetermined:
  rule: 未確定は質問生成して停止
  prohibited: 勝手に埋めない
  purpose: 嘘の PASS 防止
```

---

## 変更履歴

| 日時 | 内容 |
|------|------|
| 2026-01-03 | 初版作成。LLM 自己評価バイアス防止の設計原則を体系化。 |
