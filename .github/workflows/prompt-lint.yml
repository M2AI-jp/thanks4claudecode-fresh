name: Prompt Lint

on:
  push:
    paths:
      - 'CLAUDE.md'
      - 'governance/**'
      - 'scripts/lint_prompts.py'
  pull_request:
    paths:
      - 'CLAUDE.md'
      - 'governance/**'
      - 'scripts/lint_prompts.py'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history to check for changes
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run prompt lint
        run: python scripts/lint_prompts.py
      
      - name: Check CLAUDE.md change requires changelog update
        if: github.event_name == 'pull_request'
        run: |
          # Check if CLAUDE.md was modified
          if git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -q "^CLAUDE.md$"; then
            echo "CLAUDE.md was modified, checking changelog..."
            # Check if PROMPT_CHANGELOG.md was also modified
            if ! git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -q "governance/PROMPT_CHANGELOG.md"; then
              echo "::error::CLAUDE.md was modified but governance/PROMPT_CHANGELOG.md was not updated!"
              echo "Please document your changes in governance/PROMPT_CHANGELOG.md"
              exit 1
            fi
            echo "âœ… Changelog was updated"
          else
            echo "CLAUDE.md was not modified, skipping changelog check"
          fi
