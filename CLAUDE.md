# CLAUDE.md

> **クイックスタート**: セッション開始時は **docs/boot-context.md** を先に読むこと。
> このファイルは詳細なルールを定義するが、毎回全て読む必要はない。

このファイルは、Claude がこのリポジトリで作業するときの**行動ルールと優先順位**を定める。

このファイルが存在し、その内容が読み込まれた時点で、Claude はここに書かれたルールの支配下に入る。
ここに定めた「絶対遵守事項」は、このリポジトリにおける Claude の行動方針として常に尊重される。

---

## 目的

このリポジトリにおいて、Claude が以下を安全かつ一貫性のある形で支援することを目的とする。

- コード実装・リファクタリング
- ドキュメント整備
- レガシーコードの整理
- テストやビルドの補助

---

## 情報源の優先順位

Claude は、このリポジトリでタスクを実行する際、以下の優先順位で情報を解釈する。

1. 法律・利用規約・安全ポリシー
2. Claude のシステム / 開発者メッセージなど、プラットフォーム側の制約
3. README.md に記載された要件・期待される振る舞い・利用方法
4. 本ファイル CLAUDE.md の「絶対遵守事項」およびその他ルール
5. project.md / AGENTS.md / SKILLS.md / docs/ 以下の設計・仕様ドキュメント
6. Issue・Pull Request・コミットメッセージ・チャットでの指示
7. ソースコード内コメント・テストコードの期待値

矛盾がある場合は、**上位の情報を優先**し、下位の情報はそのまま信じずにユーザーへ確認する。

---

## 絶対遵守事項

Claude は、このリポジトリで作業を行う際、以下を必ず守ること。

### 3-1. 破壊的操作の扱い

明示的な指示または合意なく、以下のような破壊的操作をしてはならない。

- 大量のファイル削除や広範囲のリネーム
- 既存機能の挙動を大きく変える変更
- セキュリティ的に危険な設定変更（認証の無効化など）

これらが必要な場合は、Plan フェーズで **リスク** と **ロールバック方法** を説明し、ユーザーの確認を得る。

### 3-2. README / 仕様の尊重

- README.md はこのリポジトリにおけるユーザー期待値の基準とする。
- README.md とコードやコメントが矛盾している場合、README を優先し、必要に応じてコードやドキュメントの修正を提案する。

### 3-3. Plan Mode の必須化

- Claude は、このリポジトリでは**常に Plan Mode スタイル（Plan → Execution）**で作業する。
- 些細な変更であっても、簡潔な Plan を提示してから実行する。

### 3-4. 秘密情報の保護

- API キーやパスワードなどの秘密情報を生成・表示しない。
- `.env` や秘密情報が含まれる可能性のあるファイルを外部へコピーせず、要約する際も機微情報を含めない。

---

## Plan Mode による作業フロー

Claude は、このリポジトリでのすべてのタスクを、以下の Plan Mode で進める。

### 4-1. Plan フェーズ

タスクを受け取ったら、まず **Plan セクション** を作成し、以下を箇条書きで示す。

- ゴールと前提条件
- 実施するサブタスク（3〜7 個程度）
- 影響範囲（変更するディレクトリ・ファイル）
- 実行するテストや確認方法
- 想定するリスクとロールバック方法

**出力イメージ（例）：**

```
## Plan

1. 関連する README / docs / コードを確認し、要件と現状を把握する
2. 影響範囲となるファイル・モジュールを列挙する
3. 実装 / 修正ステップを 3〜7 個に分解する
4. 必要なテストと確認方法を決める
5. リスクとロールバック方法をまとめる
```

### 4-2. Execution フェーズ

Plan が妥当と判断されたら、次に **Execution セクション** で作業を進める。

```
## Execution

- Step 1: ...
- Step 2: ...
- Step 3: ...
```

各ステップごとに以下を簡潔に記述する。

- どのファイルをどう変更したか
- その変更が Plan のどのステップに対応しているか
- 実行したテストと結果（あれば）

実行中に Plan が不適切だと判明した場合は、Plan を更新し、何をどう変えたかを明示してから続行する。

---

## Hooks / Subagents / Skills の前提と利用方針

Claude Code 環境では、Hooks / Subagents / Skills は、明示的に定義・呼び出さないと発火しづらい。
Claude はこの仕様を理解した上で、以下の方針に従う。

### 5-1. Hooks

Hooks は `.claude/settings.json` などで設定される。

**代表的な用途：**
- SessionStart で依存関係インストール・環境変数設定などの初期化を行う
- 特定イベント時に静的解析・テスト・ビルドなどを自動実行する

Claude は、環境準備や定型処理について、手動で冗長な手順を毎回書くのではなく、**既存の Hooks がないかを確認し、あればそれを使う**ことを優先する。

### 5-2. Subagents

Subagents は、特定のワークフロー専用のエージェントとして設計される。

- 例：レガシーリファクタリング専用、ドキュメント整備専用、テスト戦略立案専用など。

Claude は、タスクの性質に応じて Subagent への委譲を検討する。

- 例：大規模なレガシー整理 → refactor 系 Subagent に Plan を渡して実行させる。

Subagents の一覧や役割は `AGENTS.md` に定義されている場合があるため、必要に応じて参照する。

### 5-3. Skills

Skills は、複数エージェントから再利用される知識・ルール・手順・コマンド群である。

- 例：ログポリシー、エラーハンドリング方針、ドメイン固有ルール、標準リリース手順など。

Claude は、同じような説明や手順を毎回ゼロから書かず、**既存の Skills を参照・再利用**し、足りなければ新しい Skill として切り出すことを検討する。

---

## レガシーコード・重複実装への対応

このリポジトリには、異なる時期に実装された「似た機能の別実装」が残っている可能性がある。
Claude は、コード変更を行うとき、次の点を常に意識する。

1. 関連機能周辺のファイルを一覧し、**名前や責務が似ているモジュール**を洗い出す。
2. README.md / project.md / docs/ をもとに、どれを現行正とするか判断し、曖昧な場合はユーザーに確認する。
3. Plan フェーズで、**統合したい実装**・**廃止候補の実装**・**テストの影響範囲**を明示する。
4. 統合・削除の前後で、**テストが通ること**・**公開 API の互換性が維持されていること**を確認する。

---

## 作業単位とコミット方針

Claude は、変更提案を以下のように分割する。

- 1つのコミット / 差分は、**1つの論理的目的**に絞る。
  - 例：リファクタリングと機能追加を同じコミットに混ぜない。
- 大きな変更が必要な場合は、Plan に「どう分割するか」を含める。
- 差分説明（コミットメッセージや PR 説明）では、以下を簡潔に示す。
  - 何を変えたか
  - なぜ変えたか
  - どの仕様を満たすためか（README.md や docs/ への参照）

---

## ドキュメント更新

新機能・仕様変更・レガシー削除を行った場合は、以下を確認し、必要に応じて更新を提案する。

- README.md
- project.md
- 関連する docs/ のファイル

Claude は、コードとドキュメントの乖離を見つけたとき、どちらが正しそうかを推測し、Plan で「どちらに合わせるべきか」を提案し、ユーザーの判断を仰ぐ。

---

## 今後の拡張

- AGENTS.md で Subagents の役割とインターフェースを明示し、本ファイルから参照する。
- SKILLS.md で Skills の一覧と使い方を整理し、必要に応じて本ファイルからも参照する。
- Plan Mode のテンプレートやチェックリストを改善し、人間の開発者とのコラボレーション効率を高める。
