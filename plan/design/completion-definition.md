# completion-definition.md

> **このリポジトリの「完成」を定義する**
>
> mission.md を達成した状態 = 完成

---

## 1. Mission Statement

```yaml
statement: |
  Claude Code の自律性と信頼性を最大化し、
  ユーザーの手作業に依存しないシステムを構築する。
```

---

## 2. 完成判定チェックリスト

### L1: 必須（これがないと完成ではない）

```yaml
自律性:
  - [ ] playbook を作成・実行・完了まで自律的に遂行できる
  - [ ] compact 後も作業を 100% 継続できる（Context Continuity）
  - [ ] 次タスクを mission から自動導出できる（post-loop）
  - [ ] ユーザー介入なしで 1 セッション完遂できる

信頼性:
  - [ ] Core Contract 違反時に 100% ブロックされる
  - [ ] Hook 故障が自動検知される（Feature Verification）
  - [ ] E2E テストが全て PASS する

自己認識:
  - [ ] repository-map.yaml が常に最新である（DRIFT 検知・自動更新）
  - [ ] state.md が実状態と常に一致する

自己修復:
  - [ ] ドキュメント陳腐化を自動検知する（Document Freshness）
  - [ ] 検知した問題を自動修復する（提案ではなく実行）

目的一貫性:
  - [ ] 全プロンプトで理解確認（5W1H）が実行される
  - [ ] 報酬詐欺パターンが構造的に不可能である
```

### L2: 推奨（あると大幅に品質向上）

```yaml
自己改善:
  - [ ] 失敗パターンが自動記録される（failure-logger）
  - [ ] 類似パターン検出時に事前警告される
  - [ ] 学習に基づく自動改善が行われる

可観測性:
  - [ ] セッションログが自動保存される
  - [ ] Hook 実行結果がトレース可能

拡張性:
  - [ ] 4QV+ Architecture への完全移行
  - [ ] 導火線 Hook 4 個への統合完了
```

### L3: オプション（完璧を目指すなら）

```yaml
パフォーマンス:
  - [ ] Hook 実行時間の最適化（各 < 100ms）
  - [ ] Read Hook の軽量化

ドキュメント:
  - [ ] 全機能の使用例が存在する
  - [ ] 障害対応ガイドが完備
```

---

## 3. mission.md success_criteria 対応表

| カテゴリ | success_criteria | 実装/検証方法 | 現状 |
|---------|-----------------|--------------|------|
| **自律性** | ユーザープロンプトなしで 1 playbook を完遂できる | post-loop Skill + 自動タスク導出 | △ 部分実装 |
| | compact 後も mission を見失わない | Context Continuity Layer | △ pre-compact.sh のみ |
| | 次タスクを自動導出して開始できる | post-loop Skill | △ 設計のみ |
| **信頼性** | 全 Hook が test-hooks.sh で PASS | scripts/e2e-contract-test.sh (52 ケース) | ✓ 達成 |
| | 全 SubAgent が呼び出し可能 | Task(subagent_type='pm/critic/...') | ✓ 達成 |
| | settings.json と実ファイルが一致 | Feature Verification Layer | △ 手動確認のみ |
| **自己認識** | current-implementation.md が常に最新 | Document Freshness Layer | ✗ 未実装 |
| | state.md が実状態と一致 | Hook による自動更新 | ✓ 達成 |
| | 自分が参照すべきファイルを把握 | SessionStart + repository-map.yaml | ✓ 達成 |
| **自己修復** | 陳腐化ドキュメントを自動更新 | doc-freshness-check.sh | ✗ 未実装 |
| | Hook 故障を自動検知・修復 | system-health-check.sh | ✗ 未実装 |
| | 失敗パターンから学習し再発防止 | failure-logger.sh + learning | ✗ 未実装 |
| **目的一貫性** | ユーザープロンプトに引っ張られない | Golden Path (pm 必須) | ✓ 達成 |
| | mission との整合性を常にチェック | understanding-check Skill | △ 強制されていない |
| | 報酬詐欺パターンを自己検出 | critic SubAgent + Reward Guard | ✓ 達成 |

**凡例**: ✓ 達成 | △ 部分実装 | ✗ 未実装

---

## 4. Self-Healing System 実装状況

### 4.1 全体像

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Self-Healing System                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  【Layer 1: Context Continuity】                                    [40% 実装]  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  ✓ pre-compact.sh（user-intent.md 保存）                                   │ │
│  │  ✗ 完全状態スナップショット（snapshot.json）                               │ │
│  │  ✗ SessionStart(compact) 分岐                                              │ │
│  │  ✗ 作業状態の完全復元                                                      │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  【Layer 2: Document Freshness】                                    [0% 実装]   │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  ✗ doc-freshness-check.sh（PostToolUse:Read）                              │ │
│  │  ✗ update-tracker.sh（PostToolUse:Edit/Write）                             │ │
│  │  ✗ 依存マップ（doc-dependencies.yaml）                                     │ │
│  │  ✗ 陳腐化警告の自動表示                                                    │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  【Layer 3: Feature Verification】                                  [30% 実装]  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  ✓ health-checker SubAgent（手動呼び出し）                                 │ │
│  │  ✓ DRIFT 検知（repository-map.yaml）                                       │ │
│  │  ✗ SessionStart での自動検証                                               │ │
│  │  ✗ settings.json ↔ 実ファイル整合性チェック                                │ │
│  │  ✗ 自動修復（chmod +x 等）                                                 │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  【Layer 4: Self-Improvement】                                      [0% 実装]   │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  ✗ failure-logger.sh                                                       │ │
│  │  ✗ 失敗パターン記録（failures.log）                                        │ │
│  │  ✗ learning Skill                                                          │ │
│  │  ✗ 類似パターン事前警告                                                    │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  総合実装率: 約 18%                                                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Layer 別詳細

| Layer | 目的 | 成功基準 | 現状 | Gap |
|-------|------|---------|------|-----|
| **1. Context Continuity** | compact 後の作業継続 | 作業状態が 100% 復元される | pre-compact.sh のみ | snapshot.json, compact 分岐 |
| **2. Document Freshness** | ドキュメント陳腐化防止 | 古いドキュメントに警告が出る | なし | 全て未実装 |
| **3. Feature Verification** | 機能故障の検知 | Hook 故障が自動検知される | health-checker (手動) | 自動検証, 整合性チェック |
| **4. Self-Improvement** | 失敗からの学習 | 同じ失敗を繰り返さない | なし | 全て未実装 |

---

## 5. アーキテクチャ図

### 5.1 全体構造（3 Layer + Self-Healing）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│                      thanks4claudecode-v2 ARCHITECTURE                           │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────────┐
                              │   User Prompt    │
                              └────────┬─────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    ↓                                      ↓
        ┌───────────────────────┐            ┌───────────────────────┐
        │  understanding-check  │            │   理解確認スキップ     │
        │     (5W1H 分析)       │            │   → 報酬詐欺リスク    │
        └───────────┬───────────┘            └───────────────────────┘
                    │
                    ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  LAYER 0: FROZEN CONSTITUTION (CLAUDE.md)                                       │
│  ═══════════════════════════════════════════════════════════════════════════════│
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                         Core Contract                                     │   │
│  │                                                                           │   │
│  │     Golden Path ───→ Playbook Gate ───→ Reviewer Gate                    │   │
│  │     (pm 必須)        (playbook 必須)    (critic 必須)                     │   │
│  │                                                                           │   │
│  │  ※ admin モードでも回避不可                                              │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  LAYER 1: STRUCTURAL ENFORCEMENT (Hook 導火線)                                  │
│  ═══════════════════════════════════════════════════════════════════════════════│
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │  settings.json                                                            │   │
│  │       │                                                                   │   │
│  │       ├── SessionStart ───→ session.sh ───→ State Injection               │   │
│  │       │                                                                   │   │
│  │       ├── UserPromptSubmit ───→ prompt.sh ───→ 理解確認強制              │   │
│  │       │                                                                   │   │
│  │       ├── PreToolUse(*) ───→ pre-tool.sh                                  │   │
│  │       │       ├── Edit/Write: playbook-gate, reward-guard, access-control│   │
│  │       │       └── Bash: access-control, quality-assurance                │   │
│  │       │                                                                   │   │
│  │       └── PostToolUse(*) ───→ post-tool.sh ───→ archive, PR, cleanup     │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  LAYER 2: VERIFICATION & DOMAIN KNOWLEDGE (Skills + SubAgents)                  │
│  ═══════════════════════════════════════════════════════════════════════════════│
│                                                                                  │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                            16 Skills                                      │   │
│  │  ┌─────────────────┬─────────────────┬─────────────────┬────────────────┐│   │
│  │  │  Core Contract  │  Quality        │  State & Flow   │  Dev Support   ││   │
│  │  ├─────────────────┼─────────────────┼─────────────────┼────────────────┤│   │
│  │  │ golden-path     │ reward-guard    │ state           │ lint-checker   ││   │
│  │  │ playbook-gate   │ quality-assure  │ session-manager │ test-runner    ││   │
│  │  │ access-control  │ understanding-  │ post-loop       │ deploy-checker ││   │
│  │  │                 │ check           │ plan-management │ frontend-design││   │
│  │  │                 │                 │ context-mgmt    │ git-workflow   ││   │
│  │  └─────────────────┴─────────────────┴─────────────────┴────────────────┘│   │
│  │                                                                           │   │
│  │  ┌────────────────────────────────────────────────────────────────────┐  │   │
│  │  │                         6 SubAgents                                 │  │   │
│  │  │                                                                     │  │   │
│  │  │   pm ───────→ playbook 作成（必須）                                │  │   │
│  │  │   critic ───→ done_criteria 検証（必須）                           │  │   │
│  │  │   reviewer ──→ コード/設計レビュー                                 │  │   │
│  │  │   health-checker → システム健全性監視                              │  │   │
│  │  │   codex-delegate → Codex MCP 呼び出し                              │  │   │
│  │  │   setup-guide ──→ セットアップガイド                               │  │   │
│  │  └────────────────────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  LAYER 3: SINGLE SOURCE OF TRUTH (State Management)                             │
│  ═══════════════════════════════════════════════════════════════════════════════│
│                                                                                  │
│  ┌───────────────────┐  ┌───────────────────────┐  ┌───────────────────────┐   │
│  │     state.md      │  │  playbook-*.md        │  │  repository-map.yaml  │   │
│  │  ┌─────────────┐  │  │  ┌─────────────────┐  │  │  ┌─────────────────┐  │   │
│  │  │ focus       │  │  │  │ meta            │  │  │  │ hooks: 5        │  │   │
│  │  │ playbook    │──┼──┼─→│ goal.done_when  │  │  │  │ skills: 16      │  │   │
│  │  │ goal.phase  │  │  │  │ phases          │  │  │  │ agents: 6       │  │   │
│  │  │ config      │  │  │  │ final_tasks     │  │  │  │ commands: 7     │  │   │
│  │  └─────────────┘  │  │  └─────────────────┘  │  │  └─────────────────┘  │   │
│  └───────────────────┘  └───────────────────────┘  └───────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ↓
┌─────────────────────────────────────────────────────────────────────────────────┐
│  LAYER 4: SELF-HEALING SYSTEM (未完成)                                          │
│  ═══════════════════════════════════════════════════════════════════════════════│
│                                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────┐                         │
│  │ [1] Context Continuity │  │ [2] Document Freshness │                         │
│  │     [40% 実装]         │  │     [0% 実装]          │                         │
│  │                        │  │                        │                         │
│  │ ✓ pre-compact.sh      │  │ ✗ doc-freshness-check  │                         │
│  │ ✗ snapshot.json       │  │ ✗ update-tracker       │                         │
│  │ ✗ compact 復元        │  │ ✗ 陳腐化警告           │                         │
│  └────────────────────────┘  └────────────────────────┘                         │
│                                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────┐                         │
│  │ [3] Feature Verify     │  │ [4] Self-Improvement   │                         │
│  │     [30% 実装]         │  │     [0% 実装]          │                         │
│  │                        │  │                        │                         │
│  │ ✓ health-checker      │  │ ✗ failure-logger       │                         │
│  │ ✓ DRIFT 検知          │  │ ✗ 失敗パターン学習     │                         │
│  │ ✗ 自動検証            │  │ ✗ 事前警告             │                         │
│  └────────────────────────┘  └────────────────────────┘                         │
│                                                                                  │
│  Self-Healing 総合実装率: 約 18%                                                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 データフロー（Golden Path）

```
User: 「〇〇を実装して」
        │
        ↓
┌───────────────────────┐
│ UserPromptSubmit      │
│ prompt.sh             │
│   └── State Injection │
│   └── 理解確認強制    │
└───────────┬───────────┘
            │
            ↓
┌───────────────────────┐
│ understanding-check   │
│ (5W1H 分析)           │
│   └── What/Why/Who/   │
│       Where/When/How  │
└───────────┬───────────┘
            │
            ↓
┌───────────────────────┐
│ pm SubAgent           │
│   └── playbook 作成   │
│   └── state.md 更新   │
└───────────┬───────────┘
            │
            ↓
┌───────────────────────────────────────────────────┐
│ Phase 実行ループ                                  │
│                                                   │
│   ┌─ PreToolUse ─────────────────────────────┐   │
│   │ playbook-gate: playbook 存在 ✓           │   │
│   │ access-control: 保護ファイル ✓           │   │
│   │ reward-guard: scope 変更検出 ✓           │   │
│   └──────────────────────────────────────────┘   │
│                    │                              │
│                    ↓                              │
│   [Edit/Write 実行]                               │
│                    │                              │
│                    ↓                              │
│   ┌─ Phase 完了時 ───────────────────────────┐   │
│   │ subtask 全 [x] → validations 記入        │   │
│   │                 ↓                        │   │
│   │ critic SubAgent で done_criteria 検証    │   │
│   │   PASS → 次 Phase / FAIL → ブロック      │   │
│   └──────────────────────────────────────────┘   │
└───────────────────────┬───────────────────────────┘
                        │
                        ↓
┌───────────────────────────────────────────────────┐
│ Playbook 完了                                     │
│   └── archive-playbook.sh                         │
│   └── repository-map.yaml 更新                    │
│   └── PR 作成提案                                 │
└───────────────────────┬───────────────────────────┘
                        │
                        ↓
┌───────────────────────────────────────────────────┐
│ 次タスク自動導出                                  │
│   └── post-loop Skill                             │
│   └── mission.md から次タスクを導出               │
│   └── 新 playbook 作成                            │
└───────────────────────────────────────────────────┘
```

---

## 6. 完成に必要な実装タスク

### 6.1 優先度別タスクリスト

| 優先度 | タスク | 対象 Layer | 工数目安 |
|--------|-------|-----------|---------|
| **P0** | Context Continuity 完成（snapshot.json, compact 復元） | Self-Healing L1 | 中 |
| **P0** | 理解確認の必須化（prompt.sh 強制） | Core Contract | 小 |
| **P1** | Feature Verification 自動化（SessionStart 統合） | Self-Healing L3 | 中 |
| **P1** | 4QV+ Architecture 移行完了 | Layer 1 | 大 |
| **P2** | Document Freshness Check 実装 | Self-Healing L2 | 中 |
| **P2** | failure-logger.sh 実装 | Self-Healing L4 | 小 |
| **P3** | 失敗パターン学習・事前警告 | Self-Healing L4 | 大 |

### 6.2 完成までのロードマップ

```
Phase 1: Core Contract 完全動作（現在）
├── 理解確認必須化
├── playbook 生成フロー修正
└── 目標: 報酬詐欺パターンの構造的排除

Phase 2: Self-Healing L1 + L3
├── Context Continuity（compact 後の完全復元）
├── Feature Verification（Hook 故障自動検知）
└── 目標: 手作業依存の 80% 削減

Phase 3: Self-Healing L2 + L4
├── Document Freshness（陳腐化自動検知）
├── Self-Improvement（失敗学習）
└── 目標: 自律的な品質向上サイクル

Phase 4: アーキテクチャ最適化
├── 4QV+ 完全移行
├── パフォーマンス最適化
└── 目標: 保守性・拡張性の向上
```

---

## 7. 完成判定プロセス

```yaml
判定条件:
  L1_必須チェックリスト:
    全項目が [x] であること

  Self-Healing_実装率:
    Layer 1-4 の総合実装率が 80% 以上であること

  E2E_テスト:
    scripts/e2e-contract-test.sh が 100% PASS であること

  実運用テスト:
    ユーザー介入なしで 1 playbook を完遂できること

判定者:
  - critic SubAgent（自動判定）
  - ユーザー（最終承認）

判定タイミング:
  - 各 playbook 完了時に進捗確認
  - L1 必須項目が全て達成されたら完成候補
  - 実運用テストで最終確認
```

---

## 8. 現在の達成状況サマリー

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          COMPLETION STATUS                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  L1 必須チェックリスト:  4/12 達成 (33%)                                         │
│                                                                                  │
│  Self-Healing System:                                                            │
│    Layer 1 (Context Continuity):    40%                                          │
│    Layer 2 (Document Freshness):     0%                                          │
│    Layer 3 (Feature Verification):  30%                                          │
│    Layer 4 (Self-Improvement):       0%                                          │
│    ─────────────────────────────────────                                         │
│    総合:                            18%                                          │
│                                                                                  │
│  mission.md success_criteria:                                                    │
│    自律性:       △ 部分達成                                                     │
│    信頼性:       ✓ ほぼ達成                                                     │
│    自己認識:     △ 部分達成                                                     │
│    自己修復:     ✗ 未達成                                                       │
│    目的一貫性:   △ 部分達成                                                     │
│                                                                                  │
│  総合完成度:  約 35%                                                             │
│                                                                                  │
│  次のマイルストーン: 理解確認必須化 + Context Continuity 完成                    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 変更履歴

| 日時 | 内容 |
|------|------|
| 2025-12-24 | 初版作成。mission.md + Self-Healing System の Gap 分析に基づく完成定義。 |
